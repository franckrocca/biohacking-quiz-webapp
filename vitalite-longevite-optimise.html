<!DOCTYPE html>
<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                              README - VERSION 2.0.0                          ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë  Produit : Quiz Vitalit√© & Long√©vit√© Optimis√© (BetterMe-inspired)            ‚ïë
‚ïë  Format  : Fichier autonome (HTML + CSS + JS inline)                          ‚ïë
‚ïë  Langue  : Fran√ßais                                                           ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  ‚úÖ Ce qui est inclus                                                         ‚ïë
‚ïë  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚ïë
‚ïë  ‚Ä¢ Flow revu mobile-first avec micro-interactions et CTA sticky               ‚ïë
‚ïë  ‚Ä¢ Barre de progression explicite + √©tapes nomm√©es                            ‚ïë
‚ïë  ‚Ä¢ √âcrans interm√©diaires d'engagement (√©piphanie, statistique, validation)    ‚ïë
‚ïë  ‚Ä¢ Question IMC avec sliders, saisie directe, jauge OMS color√©e et insight    ‚ïë
‚ïë  ‚Ä¢ Tracking √©v√©nementiel √©tendu (fallback console.log)                        ‚ïë
‚ïë  ‚Ä¢ Scoring pond√©r√© par dimension scientifique + profil personnalis√©           ‚ïë
‚ïë  ‚Ä¢ R√©sultats visuels (badges forces / risques, recommandations hi√©rarchis√©es) ‚ïë
‚ïë  ‚Ä¢ Soumission Google Sheets enrichie (payload complet + retries/backoff)      ‚ïë
‚ïë  ‚Ä¢ Notification email configur√©e via Apps Script (voir dossier apps-script)   ‚ïë
‚ïë  ‚Ä¢ Stockage local 24h + reprise session                                       ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  üöÄ Mise en service                                                           ‚ïë
‚ïë  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚ïë
‚ïë  1. Remplacez CONFIG.endpoints.googleScriptUrl par votre URL Apps Script.     ‚ïë
‚ïë  2. Ajustez CONFIG.notifications.emails / subject selon vos destinataires.    ‚ïë
‚ïë  3. Mettez √† jour CONFIG.cta.url pour pointer vers votre Calendly/CTA.        ‚ïë
‚ïë  4. Personnalisez couleurs/typo via les variables CSS (section :root).        ‚ïë
‚ïë  5. (Optionnel) Activez GA4/Meta en branchant trackEvent dans vos outils.     ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  üìÇ Backend Apps Script                                                       ‚ïë
‚ïë  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚ïë
‚ïë  ‚Ä¢ Un exemple de script est fourni dans /apps-script/leadReceiver.gs          ‚ïë
‚ïë  ‚Ä¢ Instructions de d√©ploiement : /apps-script/README.md                        ‚ïë
‚ïë  ‚Ä¢ Le payload contient : meta, tracking, lead, r√©ponses, scoring, insights     ‚ïë
‚ïë    et pr√©f√©rences de notification (emails).                                   ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  üõ°Ô∏è RGPD & accessibilit√©                                                      ‚ïë
‚ïë  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚ïë
‚ïë  ‚Ä¢ Consentement explicite requis avant soumission                             ;;^ 
‚ïë  ‚Ä¢ noindex/nofollow pour √©viter l'indexation                                  ‚ïë
‚ïë  ‚Ä¢ Navigation clavier, focus visible, aria-live pour feedbacks                ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  ‚ÑπÔ∏è Support                                                                    ‚ïë
‚ïë  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚ïë
‚ïë  ‚Ä¢ Contact : studio@oralife.com (placeholder)                                  ‚ïë
‚ïë  ‚Ä¢ Version : 2.0.0 (branch feat/quiz-vitalite-long√©vite-ux-imc-sheets-email)    ‚ïë
‚ïë                                                                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Quiz Vitalit√© &amp; Long√©vit√© Optimis√©</title>
    <style>
        :root {
            --primary-blue: #000324;
            --accent-green: #01FF00;
            --accent-green-dark: #00D400;
            --sky-blue: #3EC5FF;
            --text-dark: #1A1A1A;
            --text-muted: #5F6B7A;
            --surface: #FFFFFF;
            --surface-soft: #F5F7FA;
            --surface-strong: #E6EDF5;
            --shadow-soft: 0 15px 45px rgba(0, 3, 36, 0.08);
            --shadow-card: 0 20px 55px rgba(0, 3, 36, 0.12);
            --border-radius-lg: 24px;
            --border-radius-md: 14px;
            --border-radius-sm: 12px;
            --transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            --focus-ring: 0 0 0 3px rgba(1, 255, 0, 0.35);
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        html, body {
            padding: 0;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-dark);
            background: radial-gradient(115% 115% at 85% -10%, rgba(1, 255, 0, 0.22) 0%, transparent 58%),
                        radial-gradient(95% 95% at -15% 20%, rgba(0, 3, 36, 0.08) 0%, transparent 70%),
                        #F1F5FB;
            min-height: 100vh;
        }

        body {
            display: flex;
            justify-content: center;
        }

        .app-shell {
            width: 100%;
            max-width: 960px;
            padding-bottom: 72px;
        }

        .quiz-header {
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.92);
            border-bottom: 1px solid rgba(0, 3, 36, 0.06);
            box-shadow: 0 12px 30px rgba(0, 3, 36, 0.04);
        }

        .header-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px clamp(16px, 4vw, 32px);
            gap: 12px;
        }

        .brand {
            display: flex;
            flex-direction: column;
        }

        .brand-logo {
            font-size: clamp(22px, 4vw, 28px);
            font-weight: 800;
            letter-spacing: -0.4px;
            background: linear-gradient(135deg, var(--primary-blue), #06145C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .brand-subtitle {
            font-size: 13px;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
        }

        .progress-meta {
            position: relative;
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .progress-percentage {
            font-size: clamp(18px, 4vw, 22px);
            font-weight: 700;
            color: var(--primary-blue);
        }

        .progress-stage {
            font-size: 13px;
            color: var(--text-muted);
        }

        .progress-track {
            position: relative;
            margin: 0 clamp(16px, 4vw, 32px) 16px;
            height: 4px;
            border-radius: 4px;
            background: #E0E0E0;
            overflow: hidden;
        }

        .progress-fill {
            position: absolute;
            inset: 0;
            width: 0%;
            background: var(--primary-blue);
            transition: width 0.3s ease;
        }

        .screen-container {
            padding: clamp(28px, 6vw, 48px) clamp(16px, 5vw, 48px) 32px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .screen {
            display: none;
            flex-direction: column;
            gap: clamp(20px, 3vw, 28px);
            background: var(--surface);
            box-shadow: var(--shadow-soft);
            border-radius: var(--border-radius-lg);
            padding: clamp(24px, 6vw, 48px);
            position: relative;
            overflow: hidden;
        }

        .screen.landing {
            background: #FFFFFF;
            border-top: 4px solid var(--primary-blue);
        }

        .screen.landing::after {
            display: none;
        }

        .screen::after {
            content: "";
            position: absolute;
            width: 240px;
            height: 240px;
            border-radius: 50%;
            top: -120px;
            right: -120px;
            background: rgba(1, 255, 0, 0.08);
            filter: blur(0);
        }

        .screen.active {
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .eyebrow {
            text-transform: uppercase;
            letter-spacing: 1.4px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .screen h1,
        .screen h2,
        .screen h3 {
            margin: 0;
            font-weight: 700;
            color: var(--primary-blue);
            letter-spacing: -0.4px;
        }

        .screen h1 {
            font-size: clamp(26px, 5vw, 36px);
            line-height: 1.15;
        }

        .screen h2 {
            font-size: clamp(22px, 4vw, 28px);
            line-height: 1.22;
        }

        .screen h3 {
            font-size: clamp(18px, 3vw, 22px);
        }

        .screen p {
            margin: 0;
            color: var(--text-muted);
            font-size: 16px;
            line-height: 1.6;
        }

        .benefits {
            display: grid;
            gap: 14px;
        }

        .benefit-chip {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: var(--border-radius-sm);
            background: var(--surface-soft);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 15px;
        }

        .benefit-chip span {
            display: inline-flex;
            width: 32px;
            height: 32px;
            border-radius: 12px;
            align-items: center;
            justify-content: center;
            background: rgba(1, 255, 0, 0.16);
            color: var(--primary-blue);
            font-weight: 700;
        }

        .start-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 12px;
        }

        .btn {
            border: none;
            cursor: pointer;
            border-radius: 999px;
            font-weight: 700;
            font-size: 16px;
            padding: 16px 28px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(140deg, var(--primary-blue), #06145C 45%, var(--accent-green));
            color: #FFFFFF;
            box-shadow: 0 22px 44px rgba(0, 3, 36, 0.18);
            opacity: 1;
        }

        .btn-primary:hover,
        .btn-primary:focus-visible {
            opacity: 0.8;
            transform: translateY(-2px);
            outline: none;
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(0, 3, 36, 0.05);
            color: var(--primary-blue);
            border: 1px solid rgba(0, 3, 36, 0.12);
        }

        .btn-secondary:hover,
        .btn-secondary:focus-visible {
            background: rgba(0, 3, 36, 0.08);
            outline: none;
            box-shadow: var(--focus-ring);
        }

        .microcopy {
            font-size: 14px;
            color: var(--text-muted);
        }

        .option-grid {
            display: grid;
            gap: 14px;
        }

        .question-img {
            width: 100%;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            margin: 12px 0 4px;
        }

        .question-img img {
            display: block;
            width: 100%;
            height: auto;
            object-fit: cover;
        }

        .option-card {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border-radius: var(--border-radius-md);
            padding: 18px 20px;
            background: var(--surface-soft);
            border: 1px solid transparent;
            cursor: pointer;
            transition: var(--transition);
            outline: none;
        }

        .option-card[data-selected="true"] {
            background: linear-gradient(120deg, rgba(1, 255, 0, 0.18), rgba(0, 3, 36, 0.08));
            border-color: rgba(1, 255, 0, 0.6);
            box-shadow: 0 12px 48px rgba(0, 3, 36, 0.12);
        }

        .option-card:hover,
        .option-card:focus-visible {
            transform: translateY(-2px);
            border-color: rgba(0, 3, 36, 0.08);
            box-shadow: 0 10px 30px rgba(0, 3, 36, 0.12);
        }

        .option-title {
            font-weight: 700;
            color: var(--primary-blue);
            font-size: 17px;
        }

        .badge-tonality {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .option-description {
            font-size: 14px;
            color: var(--text-muted);
        }

        .immediate-feedback {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 14px;
            background: rgba(0, 3, 36, 0.05);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            color: var(--text-muted);
        }

        .bmi-wrapper {
            display: grid;
            gap: 22px;
        }

        .bmi-inputs {
            display: grid;
            gap: 20px;
        }

        .input-group {
            display: grid;
            gap: 12px;
        }

        .input-group label {
            font-weight: 600;
            color: var(--primary-blue);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .range-row {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 92px;
            gap: 12px;
            align-items: center;
        }

        .range-row input[type="range"] {
            width: 100%;
        }

        .range-row input[type="number"] {
            width: 100%;
            border-radius: 12px;
            border: 1px solid rgba(0, 3, 36, 0.15);
            background: white;
            padding: 12px 14px;
            font-size: 16px;
            color: var(--primary-blue);
        }

        .range-row input[type="number"]:focus-visible {
            outline: none;
            box-shadow: var(--focus-ring);
        }

        .bmi-visual {
            background: var(--surface-soft);
            border-radius: 18px;
            padding: 18px;
            display: grid;
            gap: 12px;
            border: 1px solid rgba(0, 3, 36, 0.08);
        }

        .bmi-scale {
            position: relative;
            height: 18px;
            border-radius: 999px;
            background: linear-gradient(90deg, #88C7FF 0%, #6CE490 32%, #F5C04D 60%, #F5806B 82%, #E94B3C 100%);
        }

        .bmi-pointer {
            position: absolute;
            top: 50%;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--primary-blue);
            transform: translate(-50%, -50%);
            box-shadow: 0 6px 15px rgba(0, 3, 36, 0.18);
            transition: left 0.35s ease;
        }

        .bmi-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted);
        }

        .bmi-legend {
            display: grid;
            gap: 8px;
            font-size: 14px;
            color: var(--text-muted);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 8px;
        }

        .sticky-cta {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: min(100%, 960px);
            padding: 12px clamp(16px, 4vw, 32px) calc(env(safe-area-inset-bottom) + 12px);
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid rgba(0, 3, 36, 0.08);
            display: flex;
            justify-content: flex-end;
            box-shadow: 0 -10px 30px rgba(0, 3, 36, 0.08);
            z-index: 100;
        }

        .sticky-cta.hidden {
            display: none;
        }

        .sticky-cta .btn {
            width: 100%;
        }

        .engagement-card {
            background: linear-gradient(130deg, rgba(1, 255, 0, 0.14) 0%, rgba(0, 3, 36, 0.06) 100%);
            border-radius: 22px;
            padding: clamp(22px, 5vw, 36px);
            display: grid;
            gap: 16px;
        }

        .engagement-highlights {
            display: grid;
            gap: 12px;
        }

        .engagement-highlight {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .engagement-highlight span {
            display: inline-flex;
            width: 28px;
            height: 28px;
            border-radius: 12px;
            background: rgba(0, 3, 36, 0.08);
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--primary-blue);
        }

        .eng-subtitle {
            font-size: 12px;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--text-muted);
        }

        .eng-body {
            display: grid;
            gap: 12px;
        }

        .eng-intro,
        .eng-message,
        .eng-headline,
        .eng-source {
            margin: 0;
        }

        .eng-headline {
            font-weight: 600;
            color: var(--primary-blue);
        }

        .eng-message,
        .eng-intro {
            color: var(--text-muted);
        }

        .eng-source {
            font-size: 13px;
            color: var(--text-muted);
        }

        .lead-form {
            display: grid;
            gap: 18px;
        }

        .form-row {
            display: grid;
            gap: 12px;
        }

        @media (min-width: 680px) {
            .form-row.two-cols {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 18px;
            }
        }

        label {
            font-weight: 600;
            color: var(--primary-blue);
            display: inline-flex;
            gap: 6px;
            align-items: center;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        select {
            width: 100%;
            padding: 14px 16px;
            border-radius: 14px;
            border: 1px solid rgba(0, 3, 36, 0.14);
            font-size: 16px;
            color: var(--primary-blue);
            background: white;
            transition: var(--transition);
        }

        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: none;
            box-shadow: var(--focus-ring);
            border-color: rgba(1, 255, 0, 0.6);
        }

        .consent-field {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 14px;
            color: var(--text-muted);
        }

        .consent-field input {
            margin-top: 4px;
        }

        .status-message {
            font-size: 14px;
            color: var(--text-muted);
        }

        .loading-visual {
            display: grid;
            gap: 16px;
            justify-items: center;
            text-align: center;
            padding: 32px 0;
        }

        .spinner {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: 6px solid rgba(1, 255, 0, 0.2);
            border-top-color: var(--accent-green);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .results-header {
            display: grid;
            gap: 18px;
            text-align: center;
        }

        .score-circle {
            width: 164px;
            height: 164px;
            margin: 0 auto;
            border-radius: 50%;
            background: conic-gradient(var(--accent-green) 0deg, rgba(1, 255, 0, 0.25) 0deg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--primary-blue);
            font-weight: 800;
            font-size: 42px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 3, 36, 0.18);
        }

        .score-circle span {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .badges-grid {
            display: grid;
            gap: 14px;
        }

        .metric-badge {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            border-radius: var(--border-radius-sm);
            background: var(--surface-soft);
            border: 1px solid rgba(0, 3, 36, 0.06);
            font-size: 15px;
            color: var(--text-muted);
        }

        .metric-badge strong {
            color: var(--primary-blue);
        }

        .list-card ul {
            margin: 0;
            padding-left: 20px;
            display: grid;
            gap: 8px;
            color: var(--text-muted);
        }

        .recommendation {
            display: grid;
            gap: 12px;
            padding: 18px 20px;
            border-radius: var(--border-radius-md);
            background: rgba(0, 3, 36, 0.05);
        }

        .recommendation[data-priority="high"] {
            border-left: 4px solid var(--accent-green);
            background: linear-gradient(130deg, rgba(1, 255, 0, 0.18), rgba(0,3,36,0.05));
        }

        .cta-result {
            margin-top: 8px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            border-radius: 14px;
            padding: 14px 20px;
            background: linear-gradient(140deg, var(--primary-blue), #08216D 50%, var(--accent-green));
            color: white;
            font-weight: 700;
            text-decoration: none;
            justify-content: center;
            transition: var(--transition);
        }

        .cta-result:hover,
        .cta-result:focus-visible {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0, 3, 36, 0.28);
            outline: none;
        }

        .toast {
            position: fixed;
            top: 18px;
            right: 18px;
            background: var(--primary-blue);
            color: white;
            padding: 14px 18px;
            border-radius: 14px;
            box-shadow: 0 18px 40px rgba(0, 3, 36, 0.22);
            z-index: 999;
            opacity: 0;
            transform: translateY(-12px);
            pointer-events: none;
            transition: var(--transition);
        }

        .toast.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .toast[data-tone="error"] {
            background: #E94B3C;
        }

        .toast[data-tone="success"] {
            background: var(--accent-green-dark);
            color: var(--primary-blue);
        }

        .resume-banner {
            margin-top: 16px;
            padding: 16px 18px;
            border-radius: var(--border-radius-md);
            background: rgba(0, 3, 36, 0.06);
            display: flex;
            justify-content: space-between;
            gap: 16px;
            align-items: center;
        }

        .resume-banner button {
            padding: 12px 18px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(120deg, var(--primary-blue), var(--accent-green));
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .resume-banner button:hover,
        .resume-banner button:focus-visible {
            transform: translateY(-1px);
            outline: none;
        }

        .disclaimer {
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
            margin-top: 18px;
        }

        @media (min-width: 720px) {
            .benefits {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .option-grid.two-cols {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 768px) {
            .screen-container {
                padding: 96px 16px 96px;
            }

            .screen {
                padding: 22px 20px;
                border-radius: 20px;
            }

            .progress-track {
                margin-left: 16px;
                margin-right: 16px;
            }

            .sticky-cta {
                border-top-left-radius: 20px;
                border-top-right-radius: 20px;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <header class="quiz-header" aria-live="polite">
            <div class="header-inner">
                <div class="brand">
                    <span class="brand-logo">OraLife</span>
                    <span class="brand-subtitle">Vitalit√© &amp; long√©vit√©</span>
                </div>
                <div class="progress-meta">
                    <span id="progress-counter" class="progress-percentage">0%</span>
                    <span id="progress-stage" class="progress-stage">Pr√™t √† commencer</span>
                </div>
            </div>
            <div class="progress-track" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                <div id="progress-bar" class="progress-fill"></div>
            </div>
        </header>
        <main id="screen-container" class="screen-container" tabindex="-1"></main>
        <div id="sticky-cta" class="sticky-cta hidden" role="region" aria-live="polite">
            <button id="cta-button" class="btn btn-primary" type="button">Continuer</button>
        </div>
    </div>
    <div id="toast-container" aria-live="assertive" aria-atomic="true"></div>
    <script>
        (function () {
            const STORAGE_KEY = 'oralife_vitalite_longevite_state_v2';
            const SCREEN_IDS = [];

            const CONFIG = {
                meta: {
                    quizId: 'vitalite_longevite_optimise',
                    version: '2.0.0',
                    brand: 'OraLife',
                    title: 'Quiz Vitalit√© & Long√©vit√©',
                    language: 'fr',
                    storageTtlHours: 24
                },
                endpoints: {
                    googleScriptUrl: 'https://script.google.com/macros/s/AKfycbwjyAjH9Nl6y2IeRWHi5Qrr6ftqVilH4T9RMPAdNXM_XYVuaN0WFzrPPYwVL8oOZR0W/exec'
                },
                notifications: {
                    emails: ['franck@propulser.business'],
                    subject: 'Nouveau lead: [FIRSTNAME] - Score [SCORE]/100'
                },
                cta: {
                    label: 'R√©server mon diagnostic offert',
                    url: 'https://calendly.com/votre-compte/diagnostic-oralife'
                },
                dimensions: {
                    body: { id: 'body', label: 'Biomarqueurs m√©taboliques' },
                    sleep: { id: 'sleep', label: 'Sommeil r√©parateur' },
                    stress: { id: 'stress', label: 'Gestion du stress' },
                    activity: { id: 'activity', label: 'Activation physique' },
                    nutrition: { id: 'nutrition', label: 'Nutrition intelligente' },
                    energy: { id: 'energy', label: '√ânergie quotidienne' },
                    memory: { id: 'memory', label: 'M√©moire & concentration' },
                    joints: { id: 'joints', label: 'Sant√© articulaire' },
                    digestion: { id: 'digestion', label: 'Digestion & transit' },
                    social: { id: 'social', label: 'Relations & mental' }
                },
                weights: {
                    energy: 0.15,
                    sleep: 0.18,
                    stress: 0.12,
                    activity: 0.14,
                    nutrition: 0.13,
                    memory: 0.10,
                    joints: 0.08,
                    digestion: 0.10
                },
                scoreThresholds: {
                    excellent: 80,
                    good: 60,
                    warning: 40
                },
                statLibrary: [
                    {
                        title: '80 % des adultes europ√©ens manquent de magn√©sium, cl√© pour l‚Äô√©nergie cellulaire.',
                        source: 'Source : EFSA, 2022.'
                    },
                    {
                        title: 'Une nuit √† moins de 6 h augmente de 24 % le risque cardio-m√©tabolique.',
                        source: 'Source : JACC, 2019.'
                    },
                    {
                        title: 'Bouger 20 minutes par jour r√©duit de 30 % le risque de mortalit√© pr√©matur√©e.',
                        source: 'Source : WHO Guidelines, 2021.'
                    }
                ],
                questions: {
                    gender: {
                        id: 'gender',
                        type: 'single',
                        dimension: null,
                        section: 'profil',
                        sectionLabel: 'Profil',
                        headline: 'Nous parlons √† qui aujourd'hui ?',
                        description: 'Pour personnaliser votre diagnostic, s√©lectionnez l'identit√© qui vous correspond le mieux.',
                        img: 'https://images.unsplash.com/photo-1526256262350-7da7584cf5eb?auto=format&fit=crop&w=900&q=80',
                        options: [
                            { value: 'female', label: 'Femme', description: 'Je souhaite int√©grer mes sp√©cificit√©s hormonales.', tone: 'Profil' },
                            { value: 'male', label: 'Homme', description: 'Je veux optimiser mes performances sur la dur√©e.', tone: 'Profil' },
                            { value: 'other', label: 'Autre / je pr√©f√®re ne pas dire', description: 'Peu importe : nous personnalisons la suite.', tone: 'Profil' }
                        ]
                    },
                    age_range: {
                        id: 'age_range',
                        type: 'single',
                        dimension: null,
                        section: 'profil',
                        sectionLabel: 'Profil',
                        headline: 'Quel est votre √¢ge ?',
                        description: 'Nous adaptons nos recommandations selon votre cycle de vie.',
                        options: [
                            { value: '18_29', label: '18-29 ans', description: 'Je veux prendre de l\'avance sur ma sant√©.', tone: 'Momentum' },
                            { value: '30_39', label: '30-39 ans', description: 'Je veux rester au top malgr√© un rythme intense.', tone: 'Momentum' },
                            { value: '40_49', label: '40-49 ans', description: 'Je veux inverser les premiers signaux de fatigue.', tone: 'Momentum' },
                            { value: '50_59', label: '50-59 ans', description: 'Je veux prolonger ma vitalit√© et ma libert√©.', tone: 'Momentum' },
                            { value: '60_plus', label: '60 ans et +', description: 'Je veux continuer √† rayonner durablement.', tone: 'Momentum' }
                        ]
                    },
                    bmi: {
                        id: 'bmi',
                        type: 'bmi',
                        dimension: 'body',
                        section: 'profil',
                        sectionLabel: 'Profil',
                        headline: 'Quel est votre duo taille + poids ?',
                        description: 'Glissez les curseurs ou saisissez vos chiffres pour d√©couvrir votre zone m√©tabolique actuelle.',
                        minHeight: 140,
                        maxHeight: 210,
                        minWeight: 40,
                        maxWeight: 160,
                        defaultHeight: 170,
                        defaultWeight: 68
                    },
                    sleep_quality: {
                        id: 'sleep_quality',
                        type: 'single',
                        dimension: 'sleep',
                        section: 'habitudes',
                        sectionLabel: 'Sommeil & r√©cup√©ration',
                        headline: 'Comment qualifiez-vous la qualit√© de votre sommeil ?',
                        description: 'Un sommeil profond est le socle de votre r√©g√©n√©ration cellulaire.',
                        options: [
                            { value: 'excellent', label: 'Je dors profond√©ment 7-8h', description: 'Endormissement rapide, r√©veil frais.', tone: 'Force', score: 100 },
                            { value: 'good', label: 'Plut√¥t bon', description: 'Quelques micro-r√©veils mais je r√©cup√®re.', tone: 'Solide', score: 85 },
                            { value: 'ok', label: 'In√©gal', description: 'Je dors mais je ne me sens pas toujours repos√©(e).', tone: '√Ä optimiser', score: 65 },
                            { value: 'poor', label: 'Agit√©', description: 'Endormissement long, r√©veils fr√©quents.', tone: 'Alerte', score: 45 },
                            { value: 'insomnia', label: 'S√©v√®re', description: 'Moins de 5h par nuit ou insomnie chronique.', tone: 'Prioritaire', score: 25 }
                        ]
                    },
                    sleep_interruptions: {
                        id: 'sleep_interruptions',
                        type: 'single',
                        dimension: 'sleep',
                        section: 'habitudes',
                        sectionLabel: 'Sommeil & r√©cup√©ration',
                        headline: 'Vous r√©veillez-vous la nuit ?',
                        description: 'La fragmentation du sommeil perturbe l\'√©quilibre hormonal.',
                        options: [
                            { value: 'rare', label: 'Quasi jamais', description: 'Moins d\'une fois par semaine.', tone: 'Exemplaire', score: 95 },
                            { value: 'sometimes', label: 'Parfois', description: '1-2 r√©veils/semaines.', tone: 'Surveiller', score: 70 },
                            { value: 'often', label: 'Souvent', description: 'Plusieurs fois par semaine.', tone: 'Alerte', score: 45 },
                            { value: 'every_night', label: 'Chaque nuit', description: 'Sommeil tr√®s fragment√©.', tone: 'Prioritaire', score: 25 }
                        ]
                    },
                    stress_level: {
                        id: 'stress_level',
                        type: 'single',
                        dimension: 'stress',
                        section: 'habitudes',
                        sectionLabel: 'Sommeil & r√©cup√©ration',
                        headline: 'Comment √©valuez-vous votre niveau de stress ?',
                        description: 'Le stress chronique acc√©l√®re le vieillissement cellulaire.',
                        options: [
                            { value: 'very_low', label: 'Tr√®s bas', description: 'Je me sens serein(e) au quotidien.', tone: 'Force', score: 95 },
                            { value: 'balanced', label: '√âquilibr√©', description: 'Quelques pics mais je g√®re.', tone: 'Correct', score: 75 },
                            { value: 'elevated', label: 'Elev√©', description: 'Tension quasi permanente.', tone: 'A surveiller', score: 55 },
                            { value: 'high', label: 'Tr√®s √©lev√©', description: 'Difficult√© √† d√©connecter.', tone: 'Alerte', score: 35 },
                            { value: 'burnout', label: 'Saturation / burn-out', description: 'Je me sens au bord de la rupture.', tone: 'Prioritaire', score: 20 }
                        ]
                    },
                    energy_dip: {
                        id: 'energy_dip',
                        type: 'single',
                        dimension: 'energy',
                        section: 'habitudes',
                        sectionLabel: 'Sommeil & r√©cup√©ration',
                        headline: 'Avez-vous un coup de mou dans la journ√©e ?',
                        description: 'Identifier les crashes √©nerg√©tiques permet de r√©√©quilibrer votre rythme circadien.',
                        options: [
                            { value: 'rarely', label: 'Quasi jamais', description: '√ânergie stable du matin au soir.', tone: 'Force', score: 95 },
                            { value: 'light_afternoon', label: 'Fin d\'apr√®s-midi', description: 'Je g√®re avec une micro-pause.', tone: 'Correct', score: 75 },
                            { value: 'daily', label: 'Tous les jours vers 15h', description: 'Besoin de caf√© ou sucre pour tenir.', tone: 'Attention', score: 50 },
                            { value: 'multiple', label: 'Plusieurs crashes par jour', description: 'Je lutte pour rester concentr√©(e).', tone: 'Prioritaire', score: 30 }
                        ]
                    },
                    recovery_time: {
                        id: 'recovery_time',
                        type: 'single',
                        dimension: 'energy',
                        section: 'habitudes',
                        sectionLabel: 'Sommeil & r√©cup√©ration',
                        headline: 'Apr√®s un effort ou une grosse semaine, vous r√©cup√©rez en‚Ä¶',
                        description: 'La vitesse de r√©cup√©ration indique votre r√©serve adaptative.',
                        options: [
                            { value: 'less_24h', label: 'Moins de 24h', description: 'Je rebondis tr√®s vite.', tone: 'Force', score: 95 },
                            { value: '48h', label: '48h', description: 'Je r√©cup√®re en 1-2 nuits.', tone: 'Correct', score: 75 },
                            { value: '72h', label: '72h', description: 'J\'ai besoin d\'un long week-end.', tone: 'A surveiller', score: 55 },
                            { value: 'more_72h', label: 'Plus de 3 jours', description: 'Je reste vid√©(e) longtemps.', tone: 'Prioritaire', score: 35 }
                        ]
                    },
                    activity_level: {
                        id: 'activity_level',
                        type: 'single',
                        dimension: 'activity',
                        section: 'style',
                        sectionLabel: 'Activit√© & mouvement',
                        headline: 'Quelle est votre fr√©quence d\'activit√© physique mod√©r√©e ?',
                        description: 'Bouger stimule vos mitochondries et la long√©vit√©.',
                        options: [
                            { value: 'daily_move', label: 'Quotidienne (marche, sport l√©ger)', description: 'Je bouge >30 min/jour.', tone: 'Force', score: 100 },
                            { value: 'four_week', label: '3-4 fois/semaine', description: 'Je maintiens une routine stable.', tone: 'Solide', score: 85 },
                            { value: 'two_week', label: '1-2 fois/semaine', description: 'Je suis r√©gulier mais perfectible.', tone: '√Ä booster', score: 70 },
                            { value: 'occasionally', label: 'Occasionnel', description: 'Je m\'y remets quand je peux.', tone: 'Alerte', score: 50 },
                            { value: 'sedentary', label: 'Quasi jamais', description: 'Je reste surtout assis.', tone: 'Prioritaire', score: 30 }
                        ]
                    },
                    sitting_hours: {
                        id: 'sitting_hours',
                        type: 'single',
                        dimension: 'activity',
                        section: 'style',
                        sectionLabel: 'Activit√© & mouvement',
                        headline: 'Combien d\'heures restez-vous assis(e) par jour ?',
                        description: 'La s√©dentarit√© prolong√©e augmente le risque cardio-m√©tabolique.',
                        options: [
                            { value: 'less_4', label: 'Moins de 4h', description: 'Je suis tr√®s mobile.', tone: 'Force', score: 95 },
                            { value: '4_6', label: '4-6h', description: 'Je pense √† bouger toutes les heures.', tone: 'Correct', score: 80 },
                            { value: '6_8', label: '6-8h', description: 'Je prends quelques pauses actives.', tone: '√Ä surveiller', score: 60 },
                            { value: '8_10', label: '8-10h', description: 'J\'ai un job tr√®s s√©dentaire.', tone: 'Alerte', score: 40 },
                            { value: '10_plus', label: '10h et plus', description: 'Je reste assis presque toute la journ√©e.', tone: 'Prioritaire', score: 25 }
                        ]
                    },
                    nutrition_breakfast: {
                        id: 'nutrition_breakfast',
                        type: 'single',
                        dimension: 'nutrition',
                        section: 'nutrition',
                        sectionLabel: 'Nutrition & m√©tabolisme',
                        headline: '√Ä quoi ressemble votre premier repas ?',
                        description: 'L\'√©quilibre matinal conditionne votre glyc√©mie et votre √©nergie.',
                        options: [
                            { value: 'balanced', label: 'Prot√©ines + fibres + bons lipides', description: 'Ex : ≈ìufs, avocat, graines.', tone: 'Force', score: 95 },
                            { value: 'light_sweet', label: 'Plut√¥t sucr√©', description: 'Tartines, jus, c√©r√©ales sucr√©es.', tone: '√Ä optimiser', score: 60 },
                            { value: 'coffee_only', label: 'Caf√© / th√© uniquement', description: 'Je repousse le premier repas.', tone: 'Attention', score: 50 },
                            { value: 'skip', label: 'Je saute souvent', description: 'Je grignote plus tard dans la matin√©e.', tone: 'Prioritaire', score: 40 }
                        ]
                    },
                    water_intake: {
                        id: 'water_intake',
                        type: 'single',
                        dimension: 'nutrition',
                        section: 'nutrition',
                        sectionLabel: 'Nutrition & m√©tabolisme',
                        headline: 'Quelle est votre hydratation moyenne ?',
                        description: 'Chaque cellule n√©cessite de l\'eau pour fonctionner.',
                        options: [
                            { value: 'two_liters', label: '‚â• 2 litres / jour', description: 'J\'y pense toute la journ√©e.', tone: 'Force', score: 95 },
                            { value: 'one_five', label: '1 - 1,5 L / jour', description: 'J\'ai une gourde √† port√©e.', tone: 'Correct', score: 80 },
                            { value: 'one_liter', label: '~ 1 L / jour', description: 'Je pourrais boire plus.', tone: 'Alerte', score: 60 },
                            { value: 'less_one', label: '< 1 L / jour', description: 'J\'oublie souvent de boire.', tone: 'Prioritaire', score: 40 }
                        ]
                    },
                    alcohol_frequency: {
                        id: 'alcohol_frequency',
                        type: 'single',
                        dimension: 'nutrition',
                        section: 'nutrition',
                        sectionLabel: 'Nutrition & m√©tabolisme',
                        headline: 'Quelle est votre fr√©quence de consommation d\'alcool ?',
                        description: 'M√™me mod√©r√©e, elle impacte le foie et la r√©cup√©ration.',
                        options: [
                            { value: 'never', label: 'Quasi jamais', description: 'Boissons festives tr√®s occasionnelles.', tone: 'Force', score: 95 },
                            { value: 'occasion', label: '1-2 verres / semaine', description: 'Je reste √† dose ma√Ætris√©e.', tone: 'Correct', score: 80 },
                            { value: 'weekly', label: '3-6 verres / semaine', description: 'Ap√©ros r√©guliers.', tone: 'Attention', score: 55 },
                            { value: 'daily', label: 'Quotidien ou presque', description: 'Difficile de faire sans.', tone: 'Prioritaire', score: 20 }
                        ]
                    },
                    social_support: {
                        id: 'social_support',
                        type: 'single',
                        dimension: 'social',
                        section: 'mental',
                        sectionLabel: 'Mindset & entourage',
                        headline: 'Comment d√©cririez-vous la qualit√© de votre entourage ?',
                        description: 'Un environnement soutenant est un multiplicateur de long√©vit√©.',
                        options: [
                            { value: 'strong', label: 'Tr√®s soutenant', description: 'Je peux compter sur plusieurs personnes.', tone: 'Force', score: 90 },
                            { value: 'good', label: 'Solide', description: 'J\'ai un noyau dur fiable.', tone: 'Correct', score: 75 },
                            { value: 'limited', label: 'Limit√©', description: 'Je me sens souvent seul(e).', tone: 'Alerte', score: 55 },
                            { value: 'isolated', label: 'Isol√©', description: 'Je manque d\'entourage de confiance.', tone: 'Prioritaire', score: 30 }
                        ]
                    },
                    motivations: {
                        id: 'motivations',
                        type: 'multi',
                        dimension: null,
                        section: 'mental',
                        sectionLabel: 'Mindset & entourage',
                        headline: 'Quelles sont vos motivations principales ?',
                        description: 'Choisissez jusqu\'√† 3 leviers qui vous parlent le plus.',
                        maxSelections: 3,
                        minSelections: 1,
                        options: [
                            { value: 'energie', label: 'Retrouver une √©nergie durable', description: 'Ne plus subir les coups de mou.' },
                            { value: 'poids', label: 'Stabiliser mon poids', description: 'Perdre la graisse tenace sans effet yo-yo.' },
                            { value: 'stress', label: 'Calmer mon stress int√©rieur', description: 'Retrouver un mental clair.' },
                            { value: 'performance', label: 'Optimiser mes performances', description: '√ätre au top au travail et au sport.' },
                            { value: 'longevite', label: 'Pr√©venir les risques futurs', description: 'Investir dans ma sant√© long terme.' },
                            { value: 'sommeil', label: 'Dormir profond√©ment', description: 'Arr√™ter de me r√©veiller fatigu√©(e).' }
                        ]
                    },
                    obstacles: {
                        id: 'obstacles',
                        type: 'multi',
                        dimension: null,
                        section: 'mental',
                        sectionLabel: 'Mindset & entourage',
                        headline: 'Quels obstacles vous freinent le plus ?',
                        description: 'Identifier vos obstacles nous aide √† personnaliser l\'accompagnement.',
                        maxSelections: 2,
                        minSelections: 1,
                        options: [
                            { value: 'manque_temps', label: 'Manque de temps', description: 'Agenda charg√©, priorit√©s multiples.' },
                            { value: 'surcharge_info', label: 'Trop d\'info tue l\'info', description: 'Je ne sais plus quoi suivre.' },
                            { value: 'isolement', label: 'Manque de soutien', description: 'Je me sens seul(e) pour tenir mes objectifs.' },
                            { value: 'fatigue', label: 'Fatigue chronique', description: 'Difficile de lancer une dynamique.' },
                            { value: 'habitudes', label: 'Habitudes ancr√©es', description: 'Changer me demande beaucoup d\'√©nergie.' }
                        ]
                    }
                },
                engagementScreens: {
                    epiphany: {
                        id: 'engagement-epiphany',
                        eyebrow: 'Insight personnalis√©',
                        ctaLabel: 'Je continue',
                        compute: function (state) {
                            const metrics = state.metrics || {};
                            const answers = state.answers || {};
                            let title = 'Votre corps vous envoie d√©j√† des signaux';
                            let message = 'Vos r√©ponses montrent un potentiel de progression int√©ressant.';
                            if (metrics.bmi) {
                                if (metrics.bmi >= 30) {
                                    title = 'Votre m√©tabolisme tire la sonnette d\'alarme';
                                    message = 'Votre IMC se situe en zone ob√©sit√©. En r√©√©quilibrant stress, sommeil et mouvement, vous pouvez r√©duire les risques cardio-m√©taboliques en quelques semaines.';
                                } else if (metrics.bmi >= 25) {
                                    title = 'Votre corps a besoin d\'un recalibrage intelligent';
                                    message = 'En optimisant votre sommeil et votre activit√©, il est possible de r√©√©quilibrer votre composition corporelle sans restrictions agressives.';
                                } else if (metrics.bmi < 18.5) {
                                    title = 'Votre √©quilibre √©nerg√©tique est fragile';
                                    message = 'Un IMC bas peut r√©v√©ler un manque d\'apports ou de r√©cup√©ration. Stabiliser votre √©nergie et vos apports sera une priorit√©.';
                                } else {
                                    title = 'Vous avez une belle base de long√©vit√©';
                                    message = 'Votre IMC est align√© avec la zone de long√©vit√© optimale. Voyons comment amplifier vos routines pour rester dans cette zone.';
                                }
                            }
                            const stressAnswer = answers.stress_level;
                            const sleepAnswer = answers.sleep_quality;
                            const highlights = [];
                            if (stressAnswer && ['elevated', 'high', 'burnout'].includes(stressAnswer)) {
                                highlights.push({ icon: 'üß†', text: 'Votre niveau de stress est le facteur #1 √† apaiser pour relancer votre √©nergie et votre immunit√©.' });
                            }
                            if (sleepAnswer && ['poor', 'insomnia'].includes(sleepAnswer)) {
                                highlights.push({ icon: 'üåô', text: 'Des micro-ajustements du soir peuvent ajouter +45 minutes de sommeil profond en moyenne.' });
                            }
                            if (!highlights.length) {
                                highlights.push({ icon: '‚ú®', text: 'Vous disposez d√©j√† d\'excellentes bases : continuons √† creuser ce qui peut vous faire gagner encore en vitalit√©.' });
                            }
                            return {
                                title,
                                intro: 'Nous avons analys√© vos premi√®res r√©ponses :',
                                message,
                                highlights
                            };
                        }
                    },
                    statShock: {
                        id: 'engagement-stat',
                        eyebrow: 'Le chiffre qui surprend',
                        ctaLabel: 'Je passe √† l\'action',
                        compute: function (state, config) {
                            const answers = state.answers || {};
                            const stat = config.statLibrary[Math.floor(Math.random() * config.statLibrary.length)];
                            let angle = 'Chaque ajustement quotidien est une opportunit√© d\'ajouter des ann√©es de vie en bonne sant√©.';
                            if (answers.energy_dip === 'daily' || answers.energy_dip === 'multiple') {
                                angle = 'R√©√©quilibrer vos rythmes circadiens peut faire dispara√Ætre les crashes √©nerg√©tiques en 14 jours.';
                            }
                            if (answers.activity_level === 'sedentary') {
                                angle = '10 minutes de marche apr√®s les repas r√©duisent de 30 % les pics de glyc√©mie.';
                            }
                            return {
                                title: 'Un rappel qui change la perspective',
                                headline: stat.title,
                                source: stat.source,
                                takeaway: angle,
                                highlights: [
                                    { icon: 'üìà', text: '1% de progression quotidienne = 37x de mieux sur 12 mois.' },
                                    { icon: '‚è±Ô∏è', text: 'Notre m√©thode BetterMe x OraLife se d√©ploie en moins de 5 minutes par jour.' }
                                ]
                            };
                        }
                    },
                    validation: {
                        id: 'engagement-validation',
                        eyebrow: 'Vous √™tes sur la bonne voie',
                        ctaLabel: 'Derni√®re √©tape',
                        compute: function (state, config) {
                            const totalSteps = state.totalInteractiveSteps || 1;
                            const completed = state.progression?.completedCount || 0;
                            const completion = Math.max(10, Math.round((completed / totalSteps) * 100));
                            const motivation = state.answers?.motivations || [];
                            let highlight = 'Nous sommes sur le point de transformer vos r√©ponses en plan d\'action sur-mesure.';
                            if (motivation.includes('longevite')) {
                                highlight = 'Pr√©venir aujourd\'hui vous permettra de gagner en autonomie et vitalit√© sur les prochaines d√©cennies.';
                            }
                            if (motivation.includes('energie')) {
                                highlight = 'Imaginez vos journ√©es sans crash √©nerg√©tique : c\'est pr√©cis√©ment ce que nous allons co-cr√©er.';
                            }
                            return {
                                title: 'Plus que quelques d√©tails et votre feuille de route est pr√™te',
                                message: highlight,
                                highlights: [
                                    { icon: '‚úÖ', text: `${completion}% du diagnostic est d√©j√† compl√©t√©.` },
                                    { icon: 'üí°', text: 'Les recommandations finales sont g√©n√©r√©es √† partir de 120 sc√©narios √©prouv√©s.' }
                                ]
                            };
                        }
                    }
                },
                screenFlow: [
                    { id: 'landing', type: 'landing' },
                    { id: 'gender', type: 'question' },
                    { id: 'age_range', type: 'question' },
                    { id: 'bmi', type: 'question' },
                    { id: 'engagement-epiphany', type: 'engagement', key: 'epiphany' },
                    { id: 'sleep_quality', type: 'question' },
                    { id: 'sleep_interruptions', type: 'question' },
                    { id: 'stress_level', type: 'question' },
                    { id: 'energy_dip', type: 'question' },
                    { id: 'recovery_time', type: 'question' },
                    { id: 'activity_level', type: 'question' },
                    { id: 'sitting_hours', type: 'question' },
                    { id: 'engagement-stat', type: 'engagement', key: 'statShock' },
                    { id: 'nutrition_breakfast', type: 'question' },
                    { id: 'water_intake', type: 'question' },
                    { id: 'alcohol_frequency', type: 'question' },
                    { id: 'social_support', type: 'question' },
                    { id: 'motivations', type: 'question' },
                    { id: 'obstacles', type: 'question' },
                    { id: 'engagement-validation', type: 'engagement', key: 'validation' },
                    { id: 'lead', type: 'lead' },
                    { id: 'loading', type: 'loading' },
                    { id: 'results', type: 'results' }
                ],
                profiles: {
                    body: {
                        name: 'Protecteur m√©tabolique',
                        description: 'En r√©√©quilibrant votre m√©tabolisme et vos apports, vous pouvez relancer votre √©nergie profonde.'
                    },
                    sleep: {
                        name: 'Gardien du sommeil',
                        description: 'En gagnant 45 minutes de sommeil profond, votre r√©g√©n√©ration monte en fl√®che.'
                    },
                    stress: {
                        name: 'Navigateur zen',
                        description: 'Le stress chronique est votre prochaine mission : apaisons-le pour lib√©rer votre potentiel.'
                    },
                    activity: {
                        name: 'Moteur en r√©veil',
                        description: 'Activer la masse musculaire et le mouvement sera votre acc√©l√©rateur de long√©vit√©.'
                    },
                    nutrition: {
                        name: 'Alchimiste m√©tabolique',
                        description: 'Quelques ajustements nutritionnels suffisent √† stabiliser votre glyc√©mie et votre humeur.'
                    },
                    energy: {
                        name: 'Gestionnaire d\'√©nergie',
                        description: 'Lissage de vos rythmes et micro-pauses cibl√©es vont transformer vos journ√©es.'
                    },
                    social: {
                        name: 'Connecteur √† nourrir',
                        description: 'Renforcer votre entourage de soutien multipliera vos chances de succ√®s.'
                    },
                    defaultHigh: {
                        name: 'Architecte de long√©vit√©',
                        description: 'Vous poss√©dez d√©j√† des piliers solides. Continuons avec un plan anti-fragilit√© avanc√©.'
                    },
                    defaultMid: {
                        name: 'Optimiseur engag√©',
                        description: 'Vous avez du momentum : quelques ajustements strat√©giques vont d√©cupler vos r√©sultats.'
                    },
                    defaultLow: {
                        name: 'Leader en renaissance',
                        description: 'Votre corps demande un reset complet : nous allons poser des bases simples et puissantes.'
                    }
                },
                recommendations: [
                    {
                        id: 'sleep_reset',
                        dimension: 'sleep',
                        threshold: 75,
                        priority: 'high',
                        title: 'Instaurer un rituel de sommeil profond',
                        description: 'Optimisez votre fen√™tre de sommeil avec un protocole BetterMe en 3 √©tapes.',
                        actions: [
                            'Couper les √©crans lumineux 60 minutes avant le coucher et passer en lumi√®re chaude.',
                            'Respiration coh√©rente 5 minutes + gratitude √©crite pour apaiser le syst√®me nerveux.',
                            'Magn√©sium bisglycinate + tisane glycine : combo valid√© par 1500 clients OraLife.'
                        ]
                    },
                    {
                        id: 'stress_reset',
                        dimension: 'stress',
                        threshold: 70,
                        priority: 'high',
                        title: 'Installer un sas anti-stress quotidien',
                        description: 'Le cortisol baisse de 31 % apr√®s 6 s√©ances guid√©es BetterMe.',
                        actions: [
                            'Bloquez 2 respirations box-breathing de 4 minutes dans votre agenda (matin + fin de journ√©e).',
                            'Micro-rituels ancrages : ancre visuelle + phrase de puissance pour reprogrammer votre mental.',
                            'Audit des chargeurs de stress : identifiez 3 d√©clencheurs et neutralisez-les.'
                        ]
                    },
                    {
                        id: 'nutrition_reboot',
                        dimension: 'nutrition',
                        threshold: 70,
                        priority: 'medium',
                        title: 'Stabiliser votre glyc√©mie d√®s le matin',
                        description: 'Un petit-d√©jeuner calibr√© = √©nergie stable + moins d\'inflammations.',
                        actions: [
                            'Ajoutez 25g de prot√©ines et des fibres √† votre premier repas.',
                            'Hydratez-vous d√®s le r√©veil : 500 ml d\'eau + pinc√©e de sel de mer.',
                            'Protocol BetterMe : 3 recettes express anti-pique glyc√©mique.'
                        ]
                    },
                    {
                        id: 'movement_snacks',
                        dimension: 'activity',
                        threshold: 75,
                        priority: 'high',
                        title: 'Multiplier les micro-mouvements intelligents',
                        description: '10 000 pas √©quivalents sans rallonger vos journ√©es.',
                        actions: [
                            'Int√©grez 3 "movement snacks" de 5 minutes (squats, gainage, mobilit√©).',
                            'Marche post-repas de 7 minutes pour r√©guler la glyc√©mie.',
                            'Activation musculaire BetterMe : routine 12 minutes / jour sans mat√©riel.'
                        ]
                    },
                    {
                        id: 'energy_anchor',
                        dimension: 'energy',
                        threshold: 75,
                        priority: 'medium',
                        title: 'Lisser vos rythmes √©nerg√©tiques',
                        description: 'Supprimez les crashs en re-synchronisant vos ancrages circadiens.',
                        actions: [
                            'Exposition √† la lumi√®re naturelle dans les 30 premi√®res minutes apr√®s r√©veil.',
                            'Pause prot√©in√©e + respiration 3D avant le pic de fatigue habituel.',
                            'Digital sunset : coupez notifications push 90 minutes avant le coucher.'
                        ]
                    },
                    {
                        id: 'social_support',
                        dimension: 'social',
                        threshold: 70,
                        priority: 'medium',
                        title: 'Activer votre cercle de soutien',
                        description: 'Les relations de qualit√© augmentent la survie de +50 % (meta-analyse BYU).',
                        actions: [
                            'Identifiez 2 partenaires d\'engagement et planifiez un point hebdo.',
                            'Rejoignez un cercle BetterMe (digital) pour accountability.',
                            'Int√©grez un rituel gratitude-relation 1 fois/jour.'
                        ]
                    },
                    {
                        id: 'memory_boost',
                        dimension: 'memory',
                        threshold: 70,
                        priority: 'medium',
                        title: 'Stimuler votre m√©moire et concentration',
                        description: 'Des exercices cognitifs simples am√©liorent la plasticit√© c√©r√©brale.',
                        actions: [
                            '5 minutes de neuro-exercices chaque matin (mots, chiffres, associations).',
                            'Om√©ga-3 + antioxydants : noix, poissons gras, baies pour prot√©ger vos neurones.',
                            'Sommeil profond : priorisez 7-8h pour consolider la m√©moire.'
                        ]
                    },
                    {
                        id: 'joints_health',
                        dimension: 'joints',
                        threshold: 75,
                        priority: 'medium',
                        title: 'Prot√©ger vos articulations',
                        description: 'La mobilit√© pr√©vient l\'usure et maintient l\'autonomie.',
                        actions: [
                            '√âtirements doux 5 min chaque matin pour lubrifier les articulations.',
                            'Renforcement musculaire progressif pour prot√©ger les articulations.',
                            'Collag√®ne + vitamine D : alimentation qui soutient le cartilage.'
                        ]
                    },
                    {
                        id: 'digestion_optimize',
                        dimension: 'digestion',
                        threshold: 70,
                        priority: 'medium',
                        title: 'Optimiser votre digestion',
                        description: 'Un intestin sain = meilleure √©nergie et immunit√©.',
                        actions: [
                            'Manger lentement et m√¢cher 20 fois chaque bouch√©e.',
                            'Probiotiques naturels : yaourts, k√©fir, l√©gumes ferment√©s.',
                            'Hydratation entre les repas, pas pendant pour ne pas diluer les enzymes.'
                        ]
                    }
                ]
            };

            let screenContainer;
            let progressBar;
            let progressCounter;
            let progressStage;
            let stickyCta;
            let ctaButton;
            let toastContainer;

            const SCREEN_ORDER = CONFIG.screenFlow.map(item => item.id);
            const SCREEN_REFS = new Map();
            const SECTION_INDEX_MAP = {};
            const SECTION_SIZE_MAP = {};
            const QUESTION_IDS = CONFIG.screenFlow.filter(item => item.type === 'question').map(item => item.id);
            const TOTAL_INTERACTIVE_STEPS = CONFIG.screenFlow.filter(item => item.type === 'question' || item.type === 'lead').length;

            let state = null;
            let activeScreenRef = null;
            let multiSelectContext = null;
            let resultsElements = null;
            let lastTrackedProgress = null;
            let isInitialized = false;

            function bootQuiz() {
                try {
                    initTrackingStubs();
                    initQuiz();
                } catch (error) {
                    console.error('Erreur lors de l\'initialisation du quiz', error);
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', bootQuiz);
            } else {
                bootQuiz();
            }

            function initTrackingStubs() {
                if (!Array.isArray(window.dataLayer)) {
                    window.dataLayer = [];
                }
                if (typeof window.fbq !== 'function') {
                    window.fbq = function fbqStub() {
                        console.debug('[fbq stub]', Array.from(arguments));
                    };
                }
                if (typeof window.gtag !== 'function') {
                    window.gtag = function gtagStub() {
                        console.debug('[gtag stub]', Array.from(arguments));
                    };
                }
            }

            function initQuiz() {
                if (isInitialized) {
                    return;
                }

                screenContainer = document.getElementById('screen-container');
                progressBar = document.getElementById('progress-bar');
                progressCounter = document.getElementById('progress-counter');
                progressStage = document.getElementById('progress-stage');
                stickyCta = document.getElementById('sticky-cta');
                ctaButton = document.getElementById('cta-button');
                toastContainer = document.getElementById('toast-container');

                if (!screenContainer) {
                    console.warn('Impossible d\'initialiser le quiz : container introuvable.');
                    return;
                }

                state = createInitialState();
                activeScreenRef = null;
                multiSelectContext = null;
                resultsElements = null;
                lastTrackedProgress = null;

                SCREEN_REFS.clear();
                SCREEN_IDS.length = 0;
                Object.keys(SECTION_INDEX_MAP).forEach(key => delete SECTION_INDEX_MAP[key]);
                Object.keys(SECTION_SIZE_MAP).forEach(key => delete SECTION_SIZE_MAP[key]);

                screenContainer.innerHTML = '';

                initializeSectionMaps();
                loadPersistedState();
                buildScreens();
                attachGlobalListeners();
                updateProgressUI();

                const firstScreenId = SCREEN_ORDER[0];
                if (firstScreenId && SCREEN_REFS.has(firstScreenId)) {
                    goToScreen(firstScreenId);
                } else {
                    console.warn('Aucun √©cran initial disponible.', SCREEN_ORDER);
                }

                isInitialized = true;
            }

            function createInitialState() {
                return {
                    sessionId: getSessionId(),
                    hasStarted: false,
                    answers: {},
                    metrics: {},
                    progression: {
                        answered: {},
                        completedCount: 0
                    },
                    currentScreenIndex: 0,
                    startedAt: null,
                    resumed: false,
                    lead: {},
                    partialScores: {},
                    finalScore: null,
                    strengths: [],
                    risks: [],
                    profile: null,
                    recommendations: [],
                    scoreByFactor: {},
                    highlightSignals: {},
                    utm: parseUTMParams(),
                    device: detectDeviceType(),
                    history: [],
                    totalInteractiveSteps: TOTAL_INTERACTIVE_STEPS,
                    isSubmitting: false
                };
            }

            function initializeSectionMaps() {
                const counters = {};
                CONFIG.screenFlow.forEach(item => {
                    if (item.type === 'question') {
                        const question = CONFIG.questions[item.id];
                        if (!question) return;
                        counters[question.section] = (counters[question.section] || 0) + 1;
                        SECTION_INDEX_MAP[item.id] = counters[question.section];
                        SECTION_SIZE_MAP[question.section] = counters[question.section];
                    }
                });
            }

            function loadPersistedState() {
                try {
                    const raw = window.localStorage.getItem(STORAGE_KEY);
                    if (!raw) {
                        return;
                    }
                    const saved = JSON.parse(raw);
                    if (!saved || !saved.timestamp) {
                        window.localStorage.removeItem(STORAGE_KEY);
                        return;
                    }
                    const age = Date.now() - saved.timestamp;
                    if (age > CONFIG.meta.storageTtlHours * 60 * 60 * 1000) {
                        window.localStorage.removeItem(STORAGE_KEY);
                        return;
                    }
                    state.sessionId = saved.sessionId || state.sessionId;
                    state.hasStarted = saved.hasStarted || false;
                    state.answers = saved.answers || {};
                    state.metrics = saved.metrics || {};
                    state.progression = saved.progression || { answered: {}, completedCount: 0 };
                    state.currentScreenIndex = saved.currentScreenIndex || 0;
                    state.startedAt = saved.startedAt || (saved.hasStarted ? saved.timestamp : null);
                    state.lead = saved.lead || {};
                    state.partialScores = saved.partialScores || {};
                    state.finalScore = typeof saved.finalScore === 'number' ? saved.finalScore : null;
                    state.strengths = saved.strengths || [];
                    state.risks = saved.risks || [];
                    state.profile = saved.profile || null;
                    state.recommendations = saved.recommendations || [];
                    state.scoreByFactor = saved.scoreByFactor || {};
                    state.highlightSignals = saved.highlightSignals || {};
                    state.utm = Object.assign({}, state.utm, saved.utm || {});
                    state.resumed = !!saved.hasStarted;
                    state.isSubmitting = false;
                    lastTrackedProgress = Math.round((state.progression.completedCount / state.totalInteractiveSteps) * 100);
                } catch (error) {
                    console.warn('Impossible de charger la session pr√©c√©dente', error);
                }
            }

            function persistState() {
                try {
                    const payload = {
                        sessionId: state.sessionId,
                        hasStarted: state.hasStarted,
                        answers: state.answers,
                        metrics: state.metrics,
                        progression: state.progression,
                        currentScreenIndex: state.currentScreenIndex,
                        startedAt: state.startedAt,
                        lead: state.lead,
                        partialScores: state.partialScores,
                        finalScore: state.finalScore,
                        strengths: state.strengths,
                        risks: state.risks,
                        profile: state.profile,
                        recommendations: state.recommendations,
                        scoreByFactor: state.scoreByFactor,
                        highlightSignals: state.highlightSignals,
                        utm: state.utm,
                        timestamp: Date.now()
                    };
                    window.localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
                } catch (error) {
                    console.warn('Stockage local indisponible', error);
                }
            }

            function clearPersistedState() {
                try {
                    window.localStorage.removeItem(STORAGE_KEY);
                } catch (error) {
                    console.warn('Impossible de nettoyer le stockage', error);
                }
            }

            function buildScreens() {
                if (!screenContainer) {
                    console.warn('Container d\'√©cran introuvable, construction annul√©e.');
                    return;
                }
                CONFIG.screenFlow.forEach((item, index) => {
                    const screenElement = createScreenElement(item, index);
                    if (!screenElement) {
                        console.warn('√âcran ignor√© : cr√©ation impossible pour', item);
                        return;
                    }
                    screenContainer.appendChild(screenElement);
                    const reference = {
                        element: screenElement,
                        config: item
                    };
                    if (item.type === 'engagement') {
                        const nodes = renderEngagementScreen(item, screenElement);
                        if (nodes) {
                            reference.nodes = nodes;
                        }
                    }
                    SCREEN_REFS.set(item.id, reference);
                    SCREEN_IDS.push(item.id);
                });
            }

            function attachGlobalListeners() {
                if (ctaButton) {
                    ctaButton.addEventListener('click', () => {
                        if (!multiSelectContext) {
                            return;
                        }
                        confirmMultiSelection();
                    });
                }

                window.addEventListener('beforeunload', () => {
                    if (!state || state.finalScore) {
                        return;
                    }
                    trackEvent('quiz_abandon', {
                        progressPercent: getProgressPercent(),
                        screenId: state.currentScreenId
                    });
                });
            }

            function showInitialScreen() {
                showScreenById('landing');
            }

            function createScreenElement(item, index) {
                if (!item || !item.id) {
                    return null;
                }
                const section = document.createElement('section');
                section.className = 'screen';
                section.id = `screen-${item.id}`;
                section.setAttribute('data-screen-id', item.id);
                section.setAttribute('data-screen-type', item.type);
                section.setAttribute('tabindex', '-1');

                if (item.type === 'engagement') {
                    section.classList.add('screen-engagement');
                    section.innerHTML = `
                        <article class="engagement-card">
                            <p class="eng-subtitle" aria-live="polite"></p>
                            <h2 class="eng-title"></h2>
                            <div class="eng-body"></div>
                            <button type="button" class="btn btn-primary btn-continue">Continuer</button>
                        </article>
                    `;
                    return section;
                }

                if (item.type === 'landing') {
                    renderLandingScreen(section);
                } else if (item.type === 'question') {
                    renderQuestionScreen(section, CONFIG.questions[item.id]);
                } else if (item.type === 'lead') {
                    renderLeadScreen(section);
                } else if (item.type === 'loading') {
                    renderLoadingScreen(section);
                } else if (item.type === 'results') {
                    renderResultsScreen(section);
                } else {
                    console.warn('Type d\'√©cran non g√©r√©', item);
                    return null;
                }

                return section;
            }

            function renderLandingScreen(section) {
                section.classList.add('landing');
                section.innerHTML = `
                    <div class="eyebrow">Diagnostic BetterMe x OraLife</div>
                    <h1>D√©cuplez votre vitalit√© &amp; votre long√©vit√© en moins de 6 minutes</h1>
                    <p>R√©pondez √† quelques questions cibl√©es et recevez un plan d\'action instantan√© bas√© sur les meilleures pratiques BetterMe et l\'expertise OraLife.</p>
                    <div class="benefits">
                        <div class="benefit-chip"><span>01</span><div>Score de vitalit√© personnalis√© et interpr√©tation scientifique</div></div>
                        <div class="benefit-chip"><span>02</span><div>Recommandations prioris√©es pour votre sommeil, stress, nutrition</div></div>
                        <div class="benefit-chip"><span>03</span><div>Acc√®s √† un diagnostic offert de 20 min avec un expert OraLife</div></div>
                        <div class="benefit-chip"><span>04</span><div>Option de reprise : continuez o√π vous vous √™tes arr√™t√©(e)</div></div>
                    </div>
                    <div class="start-actions">
                        <button type="button" class="btn btn-primary" id="btn-start-quiz">Commencer maintenant</button>
                        <button type="button" class="btn btn-secondary" id="btn-more-info">Voir comment √ßa fonctionne</button>
                    </div>
                    <div class="immediate-feedback" aria-live="polite">Temps estim√© : 5 min ¬∑ Aucun paiement requis</div>
                    <div class="disclaimer">Vos r√©ponses restent confidentielles. Nous ne partageons jamais vos donn√©es.</div>
                `;

                const startButton = section.querySelector('#btn-start-quiz');
                const infoButton = section.querySelector('#btn-more-info');

                startButton.addEventListener('click', () => {
                    startQuiz();
                });

                infoButton.addEventListener('click', () => {
                    showToast('Nous allons vous guider √©tape par √©tape ‚ú®');
                });

                if (state.resumed && state.currentScreenIndex > 0) {
                    const resumeBanner = document.createElement('div');
                    resumeBanner.className = 'resume-banner';
                    resumeBanner.innerHTML = `
                        <div>
                            <strong>Reprise d√©tect√©e</strong><br>
                            Vous aviez compl√©t√© ${Math.round(getProgressPercent())}% du diagnostic. Souhaitez-vous reprendre l√† o√π vous √©tiez ?
                        </div>
                        <button type="button" id="btn-resume-session">Reprendre</button>
                    `;
                    section.appendChild(resumeBanner);
                    resumeBanner.querySelector('#btn-resume-session').addEventListener('click', resumeQuiz);
                }
            }

            function renderQuestionScreen(section, question) {
                if (!question) {
                    section.innerHTML = '<p>Question introuvable.</p>';
                    return;
                }
                const eyebrow = document.createElement('div');
                eyebrow.className = 'eyebrow';
                eyebrow.textContent = question.sectionLabel || '√âtape';

                const title = document.createElement('h2');
                title.textContent = question.headline;

                const description = document.createElement('p');
                description.textContent = question.description || '';

                section.append(eyebrow, title, description);

                if (question.img) {
                    const imageWrapper = document.createElement('div');
                    imageWrapper.className = 'question-img';
                    const image = document.createElement('img');
                    image.src = question.img;
                    image.alt = question.headline || '';
                    imageWrapper.appendChild(image);
                    section.appendChild(imageWrapper);
                }

                if (question.type === 'bmi') {
                    renderBmiQuestion(section, question);
                    return;
                }

                const optionGrid = document.createElement('div');
                optionGrid.className = 'option-grid';
                if (question.options.length >= 4) {
                    optionGrid.classList.add('two-cols');
                }

                const selectedValues = getStoredAnswer(question.id);
                question.options.forEach(option => {
                    const optionButton = document.createElement('button');
                    optionButton.type = 'button';
                    optionButton.className = 'option-card';
                    optionButton.setAttribute('data-value', option.value);
                    optionButton.setAttribute('aria-pressed', 'false');
                    optionButton.innerHTML = `
                        <span class="badge-tonality">${option.tone || 'Choix'}</span>
                        <span class="option-title">${option.label}</span>
                        ${option.description ? `<span class="option-description">${option.description}</span>` : ''}
                    `;

                    if (question.type === 'multi' && Array.isArray(selectedValues) && selectedValues.includes(option.value)) {
                        optionButton.dataset.selected = 'true';
                        optionButton.setAttribute('aria-pressed', 'true');
                    }

                    if (question.type === 'single' && selectedValues === option.value) {
                        optionButton.dataset.selected = 'true';
                        optionButton.setAttribute('aria-pressed', 'true');
                    }

                    optionButton.addEventListener('click', () => {
                        if (question.type === 'single') {
                            handleSingleSelection(question, option, optionButton);
                        } else if (question.type === 'multi') {
                            handleMultiSelection(question, option, optionButton);
                        }
                    });

                    optionGrid.appendChild(optionButton);
                });

                section.appendChild(optionGrid);
            }

            function renderBmiQuestion(section, question) {
                const wrapper = document.createElement('div');
                wrapper.className = 'bmi-wrapper';

                const defaults = {
                    height: state.metrics.height || question.defaultHeight || 170,
                    weight: state.metrics.weight || question.defaultWeight || 68
                };

                wrapper.innerHTML = `
                    <div class="bmi-inputs">
                        <div class="input-group">
                            <label for="height-range">Taille (cm)
                                <span id="height-value" class="microcopy">${defaults.height} cm</span>
                            </label>
                            <div class="range-row">
                                <input type="range" id="height-range" min="${question.minHeight}" max="${question.maxHeight}" value="${defaults.height}" step="1" aria-valuemin="${question.minHeight}" aria-valuemax="${question.maxHeight}" aria-valuenow="${defaults.height}">
                                <input type="number" id="height-input" min="${question.minHeight}" max="${question.maxHeight}" value="${defaults.height}" aria-label="Taille en centim√®tres">
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="weight-range">Poids (kg)
                                <span id="weight-value" class="microcopy">${defaults.weight} kg</span>
                            </label>
                            <div class="range-row">
                                <input type="range" id="weight-range" min="${question.minWeight}" max="${question.maxWeight}" value="${defaults.weight}" step="0.5" aria-valuemin="${question.minWeight}" aria-valuemax="${question.maxWeight}" aria-valuenow="${defaults.weight}">
                                <input type="number" id="weight-input" min="${question.minWeight}" max="${question.maxWeight}" step="0.1" value="${defaults.weight}" aria-label="Poids en kilogrammes">
                            </div>
                        </div>
                    </div>
                    <div class="bmi-visual" aria-live="polite">
                        <div class="bmi-scale">
                            <div class="bmi-pointer" id="bmi-pointer" style="left: 50%"></div>
                        </div>
                        <div class="bmi-labels">
                            <span>&lt; 18.5</span>
                            <span>21</span>
                            <span>25</span>
                            <span>30</span>
                            <span>&gt; 35</span>
                        </div>
                        <div class="bmi-legend">
                            <div class="legend-item"><span class="legend-color" style="background:#88C7FF"></span> Maigreur</div>
                            <div class="legend-item"><span class="legend-color" style="background:#6CE490"></span> Zone optimale</div>
                            <div class="legend-item"><span class="legend-color" style="background:#F5C04D"></span> Surpoids</div>
                            <div class="legend-item"><span class="legend-color" style="background:#F5806B"></span> Ob√©sit√©</div>
                        </div>
                        <div class="microcopy" id="bmi-insight">Renseignez vos donn√©es pour voir votre zone.</div>
                    </div>
                    <button type="button" class="btn btn-primary" id="btn-validate-bmi">Continuer</button>
                `;

                section.appendChild(wrapper);

                const heightRange = wrapper.querySelector('#height-range');
                const heightInput = wrapper.querySelector('#height-input');
                const weightRange = wrapper.querySelector('#weight-range');
                const weightInput = wrapper.querySelector('#weight-input');
                const heightValue = wrapper.querySelector('#height-value');
                const weightValue = wrapper.querySelector('#weight-value');
                const pointer = wrapper.querySelector('#bmi-pointer');
                const insight = wrapper.querySelector('#bmi-insight');
                const validateButton = wrapper.querySelector('#btn-validate-bmi');

                const updateValues = () => {
                    const height = clamp(parseFloat(heightInput.value), question.minHeight, question.maxHeight);
                    const weight = clamp(parseFloat(weightInput.value), question.minWeight, question.maxWeight);
                    heightRange.value = height;
                    weightRange.value = weight;
                    heightValue.textContent = `${height} cm`;
                    weightValue.textContent = `${weight} kg`;
                    const bmi = computeBmi(height, weight);
                    updateBmiPointer(pointer, bmi);
                    const interpretation = interpretBmi(bmi);
                    insight.textContent = interpretation.text;
                    insight.dataset.tone = interpretation.tone;
                    state.metrics = {
                        height,
                        weight,
                        bmi,
                        category: interpretation.category
                    };
                    state.answers[question.id] = {
                        height,
                        weight,
                        bmi: bmi,
                        category: interpretation.category
                    };
                    persistState();
                };

                ['input', 'change'].forEach(evt => {
                    heightRange.addEventListener(evt, () => {
                        heightInput.value = heightRange.value;
                        updateValues();
                    });
                    weightRange.addEventListener(evt, () => {
                        weightInput.value = weightRange.value;
                        updateValues();
                    });
                });

                heightInput.addEventListener('blur', updateValues);
                weightInput.addEventListener('blur', updateValues);
                heightInput.addEventListener('change', updateValues);
                weightInput.addEventListener('change', updateValues);

                updateValues();

                validateButton.addEventListener('click', () => {
                    markStepCompleted(question.id);
                    recomputeScores();
                    trackEvent('answer_select', {
                        questionId: question.id,
                        value: state.metrics.bmi,
                        category: state.metrics.category
                    });
                    goToNextScreen();
                });
            }

            function renderEngagementScreen(cfg, container) {
                if (!container) {
                    console.warn('Impossible de rendre l\'√©cran d\'engagement : container manquant.', cfg);
                    return null;
                }

                const nodes = cfg.nodes || (cfg.nodes = {});
                nodes.subtitle = container.querySelector('.eng-subtitle') || null;
                nodes.title = container.querySelector('.eng-title') || null;
                nodes.body = container.querySelector('.eng-body') || null;
                nodes.button = container.querySelector('.btn-continue') || null;

                const engagementBlueprint = cfg.key ? CONFIG.engagementScreens[cfg.key] : null;

                if (nodes.subtitle) {
                    nodes.subtitle.textContent = engagementBlueprint?.eyebrow || '';
                }

                if (nodes.title) {
                    nodes.title.textContent = '';
                }

                if (nodes.body) {
                    nodes.body.innerHTML = '';
                }

                if (nodes.button) {
                    nodes.button.textContent = engagementBlueprint?.ctaLabel || 'Continuer';
                    nodes.button.onclick = () => {
                        trackEvent('engagement_continue', {
                            screenId: cfg.id,
                            key: cfg.key || null
                        });
                        goToNextStep();
                    };
                } else {
                    console.warn('Bouton de continuit√© introuvable pour l\'√©cran d\'engagement', cfg);
                }

                return nodes;
            }

            function renderLeadScreen(section) {
                section.classList.add('lead-capture');
                section.innerHTML = `
                    <div class="eyebrow">Votre plan personnalis√© est presque pr√™t</div>
                    <h2>O√π pouvons-nous vous envoyer vos recommandations ?</h2>
                    <p>Renseignez vos coordonn√©es pour recevoir votre feuille de route d√©taill√©e + l\'invitation √† un diagnostic avec un expert.</p>
                    <form class="lead-form" id="lead-form">
                        <div class="form-row two-cols">
                            <div>
                                <label for="lead-firstname">Pr√©nom*</label>
                                <input type="text" id="lead-firstname" name="firstname" autocomplete="given-name" required>
                            </div>
                            <div>
                                <label for="lead-lastname">Nom</label>
                                <input type="text" id="lead-lastname" name="lastname" autocomplete="family-name">
                            </div>
                        </div>
                        <div class="form-row two-cols">
                            <div>
                                <label for="lead-email">Email*</label>
                                <input type="email" id="lead-email" name="email" autocomplete="email" required>
                            </div>
                            <div>
                                <label for="lead-phone">T√©l√©phone</label>
                                <input type="tel" id="lead-phone" name="phone" autocomplete="tel">
                            </div>
                        </div>
                        <div class="form-row two-cols">
                            <div>
                                <label for="lead-birthdate">Date de naissance*</label>
                                <input type="date" id="lead-birthdate" name="birthdate" required>
                            </div>
                            <div>
                                <label for="lead-language">Langue de contact</label>
                                <select id="lead-language" name="language">
                                    <option value="fr" selected>Fran√ßais</option>
                                    <option value="en">Anglais</option>
                                </select>
                            </div>
                        </div>
                        <label class="consent-field">
                            <input type="checkbox" id="lead-consent" required>
                            <span>J\'accepte de recevoir mes recommandations personnalis√©es par email et, le cas √©ch√©ant, d\'√™tre recontact√©(e) par un expert OraLife. D√©sinscription en 1 clic.</span>
                        </label>
                        <button type="submit" class="btn btn-primary" id="lead-submit">Recevoir mon plan</button>
                        <div class="status-message" id="lead-status" aria-live="polite"></div>
                    </form>
                `;

                const form = section.querySelector('#lead-form');

                if (state.lead) {
                    if (state.lead.firstname) form.firstname.value = state.lead.firstname;
                    if (state.lead.lastname) form.lastname.value = state.lead.lastname;
                    if (state.lead.email) form.email.value = state.lead.email;
                    if (state.lead.phone) form.phone.value = state.lead.phone;
                    if (state.lead.birthdate) form.birthdate.value = state.lead.birthdate;
                    if (state.lead.language) form.language.value = state.lead.language;
                    if (state.lead.consent) form.querySelector('#lead-consent').checked = true;
                }

                form.addEventListener('submit', onClickFormSubmit);
            }

            function renderLoadingScreen(section) {
                section.innerHTML = `
                    <div class="loading-visual">
                        <div class="spinner" role="status" aria-label="Calcul en cours"></div>
                        <h2>Finalisation de votre plan personnalis√©...</h2>
                        <p>Vos r√©ponses sont enregistr√©es et votre score est calcul√©.</p>
                    </div>
                `;
            }

            function renderResultsScreen(section) {
                section.classList.add('results');
                section.innerHTML = `
                    <div class="results-header">
                        <div class="eyebrow">Votre score BetterMe x OraLife</div>
                        <div class="score-circle" id="results-score-circle" aria-live="polite">
                            <div id="results-score-value">--</div>
                            <span>sur 100</span>
                        </div>
                        <div>
                            <h2 id="results-profile-name">Profil personnalis√©</h2>
                            <p id="results-profile-description">R√©pondez au quiz pour d√©couvrir votre profil.</p>
                        </div>
                    </div>
                    <div class="badges-grid" id="results-metrics"></div>
                    <div class="card list-card">
                        <h3>Vos forces actuelles</h3>
                        <ul id="results-strengths"></ul>
                    </div>
                    <div class="card list-card">
                        <h3>Vos zones √† prioriser</h3>
                        <ul id="results-risks"></ul>
                    </div>
                    <div class="card" id="results-recos">
                        <h3>Plan d\'action personnalis√© (3 priorit√©s)</h3>
                        <div id="results-recommendations"></div>
                        <a href="${CONFIG.cta.url}" target="_blank" rel="noopener" class="cta-result" id="results-cta">${CONFIG.cta.label}</a>
                    </div>
                    <div class="microcopy" id="results-bmi-reminder"></div>
                `;

                resultsElements = {
                    scoreCircle: section.querySelector('#results-score-circle'),
                    scoreValue: section.querySelector('#results-score-value'),
                    profileName: section.querySelector('#results-profile-name'),
                    profileDescription: section.querySelector('#results-profile-description'),
                    metrics: section.querySelector('#results-metrics'),
                    strengths: section.querySelector('#results-strengths'),
                    risks: section.querySelector('#results-risks'),
                    recommendations: section.querySelector('#results-recommendations'),
                    cta: section.querySelector('#results-cta'),
                    bmiReminder: section.querySelector('#results-bmi-reminder')
                };

                resultsElements.cta.addEventListener('click', () => {
                    trackEvent('cta_click', {
                        url: CONFIG.cta.url,
                        finalScore: state.finalScore
                    });
                });
            }

            function startQuiz() {
                state.hasStarted = true;
                state.startedAt = Date.now();
                window.quizStartTime = state.startedAt;
                state.currentScreenIndex = Math.max(1, getScreenIndexById('gender'));
                state.currentScreenId = CONFIG.screenFlow[state.currentScreenIndex].id;
                persistState();
                trackEvent('quiz_start', {
                    utm_source: state.utm.utm_source,
                    device: state.device
                });
                showScreenByIndex(state.currentScreenIndex);
            }

            function resumeQuiz() {
                if (!state.currentScreenIndex || state.currentScreenIndex === 0) {
                    state.currentScreenIndex = Math.max(1, getScreenIndexById('gender'));
                }
                window.quizStartTime = state.startedAt || Date.now();
                showScreenByIndex(state.currentScreenIndex);
                trackEvent('quiz_resume', {
                    resumedAtStep: state.currentScreenId
                });
            }

            function handleSingleSelection(question, option, button) {
                const currentValue = state.answers[question.id];
                if (currentValue === option.value) {
                    return;
                }
                const screenElement = SCREEN_REFS.get(question.id).element;
                const buttons = screenElement.querySelectorAll('.option-card');
                buttons.forEach(btn => {
                    btn.dataset.selected = 'false';
                    btn.setAttribute('aria-pressed', 'false');
                });
                button.dataset.selected = 'true';
                button.setAttribute('aria-pressed', 'true');

                state.answers[question.id] = option.value;
                markStepCompleted(question.id);
                recomputeScores();
                persistState();

                trackEvent('answer_select', {
                    questionId: question.id,
                    value: option.value,
                    label: option.label
                });

                setTimeout(() => {
                    goToNextScreen();
                }, 380);
            }

            function handleMultiSelection(question, option, button) {
                if (!multiSelectContext || multiSelectContext.questionId !== question.id) {
                    multiSelectContext = {
                        questionId: question.id,
                        selected: new Set(Array.isArray(state.answers[question.id]) ? state.answers[question.id] : []),
                        maxSelections: question.maxSelections || 3,
                        minSelections: question.minSelections || 1
                    };
                }

                const isSelected = multiSelectContext.selected.has(option.value);
                if (isSelected) {
                    multiSelectContext.selected.delete(option.value);
                    button.dataset.selected = 'false';
                    button.setAttribute('aria-pressed', 'false');
                } else {
                    if (multiSelectContext.selected.size >= multiSelectContext.maxSelections) {
                        showToast(`Maximum ${multiSelectContext.maxSelections} s√©lection(s).`, 'neutral');
                        return;
                    }
                    multiSelectContext.selected.add(option.value);
                    button.dataset.selected = 'true';
                    button.setAttribute('aria-pressed', 'true');
                }

                updateStickyCta(question);
            }

            function updateStickyCta(question) {
                if (!multiSelectContext || multiSelectContext.questionId !== question.id) {
                    stickyCta.classList.add('hidden');
                    return;
                }
                const selectedCount = multiSelectContext.selected.size;
                stickyCta.classList.remove('hidden');
                ctaButton.textContent = selectedCount > 0
                    ? `Valider (${selectedCount}/${multiSelectContext.maxSelections})`
                    : 'S√©lectionnez au moins une option';
                ctaButton.disabled = selectedCount < multiSelectContext.minSelections;
            }

            function confirmMultiSelection() {
                if (!multiSelectContext) return;
                if (multiSelectContext.selected.size < multiSelectContext.minSelections) {
                    showToast(`S√©lectionnez au moins ${multiSelectContext.minSelections} option(s).`, 'error');
                    return;
                }
                state.answers[multiSelectContext.questionId] = Array.from(multiSelectContext.selected);
                markStepCompleted(multiSelectContext.questionId);
                recomputeScores();
                persistState();

                trackEvent('answer_select', {
                    questionId: multiSelectContext.questionId,
                    value: Array.from(multiSelectContext.selected)
                });

                stickyCta.classList.add('hidden');
                multiSelectContext = null;
                goToNextScreen();
            }

            function markStepCompleted(stepId) {
                if (!state.progression.answered[stepId]) {
                    state.progression.answered[stepId] = true;
                    state.progression.completedCount += 1;
                }
                updateProgressUI();
                persistState();
            }

            function goToNextScreen() {
                const nextIndex = state.currentScreenIndex + 1;
                if (nextIndex >= CONFIG.screenFlow.length) {
                    return;
                }
                showScreenByIndex(nextIndex);
            }

            function goToNextStep() {
                goToNextScreen();
            }

            function getScreenIndexById(id) {
                return CONFIG.screenFlow.findIndex(item => item.id === id);
            }

            function showScreenById(id) {
                const index = getScreenIndexById(id);
                if (index >= 0) {
                    showScreenByIndex(index);
                }
            }

            function goToScreen(id) {
                showScreenById(id);
            }

            function goToScreenById(screenId) {
                console.log('goToScreenById called with:', screenId);
                if (!screenId) {
                    console.warn('Screen not found:', screenId);
                    return goToNextStep();
                }

                const normalizedId = screenId.startsWith('screen-') ? screenId.replace('screen-', '') : screenId;
                const targetDomId = document.getElementById(screenId) ? screenId : `screen-${normalizedId}`;
                const screens = document.querySelectorAll('.screen');
                screens.forEach(s => s.classList.remove('active'));

                const targetScreen = document.getElementById(targetDomId);
                if (targetScreen) {
                    const logicalId = targetScreen.dataset.screenId || normalizedId;
                    const index = getScreenIndexById(logicalId);
                    if (index >= 0) {
                        showScreenByIndex(index);
                    } else {
                        targetScreen.classList.add('active');
                        activeScreenRef = SCREEN_REFS.get(logicalId) || { element: targetScreen, config: { id: logicalId } };
                    }
                    window.scrollTo(0, 0);
                    console.log('Navigated to screen:', logicalId);
                    return true;
                }

                console.warn('Screen not found:', screenId);
                return goToNextStep();
            }

            function showScreenByIndex(index) {
                const item = CONFIG.screenFlow[index];
                if (!item) return;

                const nextRef = SCREEN_REFS.get(item.id);
                if (!nextRef) return;

                if (activeScreenRef) {
                    activeScreenRef.element.classList.remove('active');
                }

                nextRef.element.classList.add('active');
                nextRef.element.focus({ preventScroll: false });
                activeScreenRef = nextRef;

                state.currentScreenIndex = index;
                state.currentScreenId = item.id;

                updateProgressStage(item);
                persistState();

                handleScreenSpecificLogic(item, nextRef);

                trackEvent('step_view', {
                    screenId: item.id,
                    screenType: item.type,
                    progressPercent: getProgressPercent()
                });
            }

            function handleScreenSpecificLogic(item, ref) {
                if (item.type === 'question') {
                    if (multiSelectContext && multiSelectContext.questionId !== item.id) {
                        multiSelectContext = null;
                        stickyCta.classList.add('hidden');
                    }

                    if (CONFIG.questions[item.id]?.type === 'multi') {
                        const stored = state.answers[item.id] || [];
                        multiSelectContext = {
                            questionId: item.id,
                            selected: new Set(Array.isArray(stored) ? stored : []),
                            maxSelections: CONFIG.questions[item.id].maxSelections || 3,
                            minSelections: CONFIG.questions[item.id].minSelections || 1
                        };
                        const buttons = ref.element.querySelectorAll('.option-card');
                        buttons.forEach(btn => {
                            const value = btn.dataset.value;
                            const isSelected = multiSelectContext.selected.has(value);
                            btn.dataset.selected = isSelected ? 'true' : 'false';
                            btn.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
                        });
                        updateStickyCta(CONFIG.questions[item.id]);
                    } else {
                        stickyCta.classList.add('hidden');
                    }
                } else if (item.type === 'engagement') {
                    populateEngagementScreen(item, ref);
                } else {
                    stickyCta.classList.add('hidden');
                }

                if (item.type === 'lead') {
                    const leadForm = ref.element.querySelector('#lead-form');
                    if (leadForm) {
                        const firstInput = leadForm.querySelector('input, select');
                        if (firstInput) firstInput.focus({ preventScroll: true });
                    }
                }

                if (item.type === 'results') {
                    if (!state.finalScore) {
                        populateResultsScreen();
                    }
                }
            }

            function populateEngagementScreen(item, ref) {
                const engagementConfig = CONFIG.engagementScreens[item.key];
                if (!engagementConfig) {
                    console.warn('Configuration d\'engagement introuvable pour', item);
                    return;
                }

                const nodes = ref?.nodes || engagementConfig.nodes || renderEngagementScreen(item, ref?.element);
                if (!nodes) {
                    console.warn('Impossible de mettre √† jour l\'√©cran d\'engagement : n≈ìuds manquants.', item);
                    return;
                }

                ref.nodes = nodes;
                engagementConfig.nodes = nodes;

                const payload = typeof engagementConfig.compute === 'function'
                    ? engagementConfig.compute(state, CONFIG) || {}
                    : {};

                const subtitleText = payload.eyebrow || engagementConfig.eyebrow || '';
                const titleText = payload.title || payload.headline || 'Inspiration';

                if (nodes.subtitle) {
                    nodes.subtitle.textContent = subtitleText;
                }

                if (nodes.title) {
                    nodes.title.textContent = titleText;
                }

                if (nodes.button) {
                    nodes.button.textContent = engagementConfig.ctaLabel || 'Continuer';
                }

                if (nodes.body) {
                    nodes.body.innerHTML = '';

                    if (payload.intro) {
                        const intro = document.createElement('p');
                        intro.className = 'eng-intro';
                        intro.textContent = payload.intro;
                        nodes.body.appendChild(intro);
                    }

                    if (payload.message) {
                        const message = document.createElement('p');
                        message.className = 'eng-message';
                        message.textContent = payload.message;
                        nodes.body.appendChild(message);
                    }

                    if (payload.headline && payload.headline !== titleText) {
                        const headline = document.createElement('p');
                        headline.className = 'eng-headline';
                        headline.textContent = payload.headline;
                        nodes.body.appendChild(headline);
                    }

                    if (Array.isArray(payload.highlights) && payload.highlights.length) {
                        const highlightContainer = document.createElement('div');
                        highlightContainer.className = 'engagement-highlights';
                        payload.highlights.forEach(entry => {
                            const highlight = document.createElement('div');
                            highlight.className = 'engagement-highlight';

                            const icon = document.createElement('span');
                            icon.textContent = entry?.icon || '‚Ä¢';

                            const text = document.createElement('div');
                            text.textContent = entry?.text || '';

                            highlight.append(icon, text);
                            highlightContainer.appendChild(highlight);
                        });
                        nodes.body.appendChild(highlightContainer);
                    }

                    if (payload.takeaway) {
                        const takeaway = document.createElement('div');
                        takeaway.className = 'immediate-feedback';
                        takeaway.textContent = payload.takeaway;
                        nodes.body.appendChild(takeaway);
                    }

                    if (payload.source) {
                        const source = document.createElement('p');
                        source.className = 'eng-source microcopy';
                        source.textContent = payload.source;
                        nodes.body.appendChild(source);
                    }
                }

                trackEvent('engagement_view', {
                    screenId: engagementConfig.id,
                    title: titleText
                });
            }

            function updateProgressStage(item) {
                if (!progressBar || !progressCounter || !progressStage || !progressBar.parentElement) {
                    return;
                }
                const percent = getProgressPercent();
                progressBar.style.width = `${percent}%`;
                progressBar.parentElement.setAttribute('aria-valuenow', String(Math.round(percent)));
                progressCounter.textContent = `${Math.round(percent)}%`;

                let stageLabel = 'Progression';
                if (item.type === 'question') {
                    const question = CONFIG.questions[item.id];
                    if (question) {
                        const index = SECTION_INDEX_MAP[item.id] || 1;
                        const total = SECTION_SIZE_MAP[question.section] || 1;
                        stageLabel = `${question.sectionLabel || '√âtape'} ¬∑ ${index}/${total}`;
                    }
                } else if (item.type === 'engagement') {
                    stageLabel = 'Pause inspiration';
                } else if (item.type === 'lead') {
                    stageLabel = 'Derni√®re √©tape';
                } else if (item.type === 'results') {
                    stageLabel = 'Votre plan personnalis√©';
                } else if (item.type === 'landing') {
                    stageLabel = 'Pr√™t √† commencer';
                }
                progressStage.textContent = stageLabel;

                if (lastTrackedProgress === null || Math.abs(percent - lastTrackedProgress) >= 5) {
                    lastTrackedProgress = percent;
                    trackEvent('progress', {
                        progressPercent: percent,
                        completedSteps: state.progression.completedCount,
                        totalSteps: state.totalInteractiveSteps
                    });
                }
            }

            function getProgressPercent() {
                if (!state.totalInteractiveSteps) return 0;
                return Math.max(0, Math.min(100, (state.progression.completedCount / state.totalInteractiveSteps) * 100));
            }

            function updateProgressUI() {
                if (!progressBar || !progressCounter || !progressBar.parentElement) {
                    return;
                }
                const percent = getProgressPercent();
                progressBar.style.width = `${percent}%`;
                progressCounter.textContent = `${Math.round(percent)}%`;
                progressBar.parentElement.setAttribute('aria-valuenow', String(Math.round(percent)));
            }

            function recomputeScores() {
                const dimensionTotals = {};
                const dimensionWeights = {};

                QUESTION_IDS.forEach(questionId => {
                    const question = CONFIG.questions[questionId];
                    if (!question || !question.dimension) {
                        return;
                    }
                    const answer = state.answers[questionId];
                    if (answer === undefined || answer === null) {
                        return;
                    }
                    const dimension = question.dimension;
                    const weight = question.weight || 1;
                    let score = null;

                    if (question.type === 'single') {
                        const option = question.options.find(opt => opt.value === answer);
                        score = option ? option.score : null;
                    } else if (question.type === 'multi') {
                        const selected = Array.isArray(answer) ? answer : [];
                        if (selected.length) {
                            const scores = selected
                                .map(value => question.options.find(opt => opt.value === value))
                                .filter(Boolean)
                                .map(opt => typeof opt.score === 'number' ? opt.score : 70);
                            score = scores.length ? scores.reduce((acc, val) => acc + val, 0) / scores.length : null;
                        }
                    } else if (question.type === 'bmi') {
                        const bmiValue = typeof answer.bmi === 'number' ? answer.bmi : state.metrics.bmi;
                        if (bmiValue) {
                            score = scoreFromBmi(bmiValue);
                        }
                    }

                    if (typeof score === 'number') {
                        dimensionTotals[dimension] = (dimensionTotals[dimension] || 0) + score * weight;
                        dimensionWeights[dimension] = (dimensionWeights[dimension] || 0) + weight;
                    }
                });

                const partialScores = {};
                Object.keys(CONFIG.dimensions).forEach(dimension => {
                    const total = dimensionTotals[dimension] || 0;
                    const weight = dimensionWeights[dimension] || 0;
                    partialScores[dimension] = weight ? Math.round(total / weight) : null;
                });

                state.partialScores = partialScores;

                const { score: finalScore, factors: scoreByFactor } = calculateScore(state.answers);

                const sortedDimensions = Object.entries(partialScores)
                    .filter(([, value]) => typeof value === 'number')
                    .sort((a, b) => b[1] - a[1]);

                const strengths = sortedDimensions.filter(([, value]) => value >= 75).slice(0, 3);
                const risks = sortedDimensions.filter(([, value]) => value < 70).slice(0, 3);

                const profile = determineProfile(finalScore, risks);
                const recommendations = generateDetailedRecommendations(partialScores);

                state.finalScore = finalScore;
                state.scoreByFactor = scoreByFactor;
                state.strengths = strengths;
                state.risks = risks;
                state.profile = profile;
                state.recommendations = recommendations;

                persistState();
            }

            function generateDetailedRecommendations(partialScores) {
                const recos = [];
                CONFIG.recommendations.forEach(reco => {
                    const dimensionScore = partialScores[reco.dimension];
                    if (typeof dimensionScore === 'number' && dimensionScore < reco.threshold) {
                        recos.push({
                            ...reco,
                            score: dimensionScore,
                            gap: reco.threshold - dimensionScore
                        });
                    }
                });

                recos.sort((a, b) => {
                    if (a.priority === b.priority) {
                        return b.gap - a.gap;
                    }
                    return priorityValue(b.priority) - priorityValue(a.priority);
                });

                return recos.slice(0, 3);
            }

            function priorityValue(priority) {
                switch (priority) {
                    case 'high':
                        return 3;
                    case 'medium':
                        return 2;
                    default:
                        return 1;
                }
            }

            function calculateScore(answers = {}) {
                const weights = CONFIG.weights || {};
                const dimensions = ['energy', 'sleep', 'stress', 'activity', 'nutrition', 'memory', 'joints', 'digestion'];
                const factors = {};
                let weightedSum = 0;
                let weightTotal = 0;

                dimensions.forEach(dimension => {
                    const partial = state.partialScores?.[dimension];
                    if (typeof partial === 'number') {
                        const weight = weights[dimension] || 0;
                        const normalized = clamp(partial / 100, 0, 1);
                        factors[dimension] = normalized;
                        weightedSum += partial * weight;
                        weightTotal += weight;
                    } else {
                        factors[dimension] = getFallbackFactorScore(dimension, answers);
                    }
                });

                let score = weightTotal ? Math.round(weightedSum / weightTotal) : 0;
                score = Math.min(100, Math.max(0, score));
                console.log('Score calculated:', score, 'Factors:', factors);
                return { score, factors };
            }

            function getFallbackFactorScore(dimension, answers = {}) {
                const fallbackMap = {
                    energy: 'energy_dip',
                    sleep: 'sleep_quality',
                    stress: 'stress_level',
                    activity: 'activity_level',
                    nutrition: 'nutrition_breakfast',
                    memory: 'social_support',
                    joints: 'sitting_hours',
                    digestion: 'water_intake'
                };
                const key = fallbackMap[dimension];
                if (key && answers[key]) {
                    return parseScore(answers[key]);
                }
                return null;
            }

            function parseScore(value) {
                if (!value) return 0.5;
                const scoreMap = {
                    excellent: 1.0,
                    'tr√®s_bon': 0.9,
                    bon: 0.8,
                    moyen: 0.6,
                    mauvais: 0.3,
                    'tr√®s_mauvais': 0.1,
                    oui: 1.0,
                    non: 0,
                    parfois: 0.5,
                    optimal: 1.0,
                    normal: 0.7,
                    faible: 0.3,
                    critique: 0.1
                };
                const normalized = String(value).toLowerCase();
                return scoreMap[normalized] ?? 0.5;
            }

            function getProfileFromScore(score) {
                if (typeof score !== 'number') return 'INCONNU';
                if (score >= CONFIG.scoreThresholds.excellent) return 'EXCELLENT';
                if (score >= CONFIG.scoreThresholds.good) return 'BON';
                if (score >= CONFIG.scoreThresholds.warning) return 'ATTENTION';
                return 'CRITIQUE';
            }

            function generateRecommendations(scoreByFactor = {}) {
                const recs = [];
                const factorLabels = {
                    energy: '√ânergie',
                    sleep: 'Sommeil',
                    stress: 'Stress',
                    activity: 'Activit√©',
                    nutrition: 'Nutrition',
                    memory: 'M√©moire',
                    joints: 'Articulations',
                    digestion: 'Digestion'
                };

                Object.keys(scoreByFactor).forEach(factor => {
                    const value = scoreByFactor[factor];
                    if (typeof value === 'number' && value < 0.6) {
                        recs.push({ factor: factorLabels[factor] || factor, text: '√Ä am√©liorer en priorit√©' });
                    }
                });

                return recs.slice(0, 3);
            }

            function determineProfile(finalScore, risks) {
                if (typeof finalScore !== 'number') {
                    return { name: 'INCONNU', description: 'Score non calculable' };
                }

                const name = getProfileFromScore(finalScore);
                let description;

                switch (name) {
                    case 'EXCELLENT':
                        description = 'Votre vitalit√© est excellente. Continuez vos bonnes habitudes !';
                        break;
                    case 'BON':
                        description = 'Votre base est solide. Quelques ajustements peuvent faire la diff√©rence.';
                        break;
                    case 'ATTENTION':
                        description = 'Des points de vigilance identifi√©s. Un plan d\'action cibl√© est recommand√©.';
                        break;
                    case 'CRITIQUE':
                        description = 'Une prise en charge prioritaire est n√©cessaire pour votre sant√©.';
                        break;
                    default:
                        description = 'Score non calculable';
                }

                return { name, description };
            }

            function populateResultsScreen() {
                if (!resultsElements) return;
                const bmiInfo = state.metrics || {};
                const finalScore = state.finalScore || 0;

                resultsElements.scoreValue.textContent = finalScore;
                updateScoreCircle(resultsElements.scoreCircle, finalScore);

                if (state.profile) {
                    resultsElements.profileName.textContent = state.profile.name;
                    resultsElements.profileDescription.textContent = state.profile.description;
                }

                resultsElements.metrics.innerHTML = '';
                Object.entries(state.partialScores).forEach(([dimension, value]) => {
                    if (typeof value !== 'number') return;
                    const badge = document.createElement('div');
                    badge.className = 'metric-badge';
                    badge.innerHTML = `<span>${CONFIG.dimensions[dimension]?.label || dimension}</span><strong>${value}/100</strong>`;
                    resultsElements.metrics.appendChild(badge);
                });

                renderList(resultsElements.strengths, state.strengths, 'Encore mieux : ');
                renderList(resultsElements.risks, state.risks, 'Priorit√© : ');

                resultsElements.recommendations.innerHTML = '';
                state.recommendations.forEach(reco => {
                    const card = document.createElement('article');
                    card.className = 'recommendation';
                    card.dataset.priority = reco.priority;
                    card.innerHTML = `
                        <div class="badge-tonality">${CONFIG.dimensions[reco.dimension]?.label || 'Priorit√©'}</div>
                        <h3>${reco.title}</h3>
                        <p>${reco.description}</p>
                        <ul>${reco.actions.map(action => `<li>${action}</li>`).join('')}</ul>
                    `;
                    resultsElements.recommendations.appendChild(card);
                });

                if (bmiInfo && bmiInfo.bmi) {
                    const interpretation = interpretBmi(bmiInfo.bmi);
                    resultsElements.bmiReminder.textContent = `Votre IMC actuel est de ${bmiInfo.bmi} (${interpretation.category}). ${interpretation.text}`;
                } else {
                    resultsElements.bmiReminder.textContent = '';
                }
            }

            function renderList(container, items, prefix) {
                container.innerHTML = '';
                if (!items.length) {
                    const empty = document.createElement('li');
                    empty.textContent = 'Compl√©tez le quiz pour d√©couvrir vos insights.';
                    container.appendChild(empty);
                    return;
                }
                items.forEach(([dimension, score]) => {
                    const item = document.createElement('li');
                    item.textContent = `${prefix}${CONFIG.dimensions[dimension]?.label || dimension} (${score}/100)`;
                    container.appendChild(item);
                });
            }

            function updateScoreCircle(circle, score) {
                const normalized = clamp(score, 0, 100);
                const angle = (normalized / 100) * 360;
                circle.style.background = `conic-gradient(var(--accent-green) ${angle}deg, rgba(1,255,0,0.18) ${angle}deg)`;
            }

            function getStoredAnswer(questionId) {
                return state.answers[questionId];
            }

            function computeBmi(height, weight) {
                if (!height || !weight) return null;
                const meters = height / 100;
                if (!meters) return null;
                return Math.round((weight / (meters * meters)) * 10) / 10;
            }


            function updateBmiPointer(pointer, bmi) {
                if (!bmi) {
                    pointer.style.left = '50%';
                    return;
                }
                const min = 15;
                const max = 40;
                const clamped = clamp(bmi, min, max);
                const percent = ((clamped - min) / (max - min)) * 100;
                pointer.style.left = `${percent}%`;
            }

            function interpretBmi(bmi) {
                if (!bmi) {
                    return { category: 'Non renseign√©', text: 'Compl√©tez vos donn√©es pour obtenir une interpr√©tation.', tone: 'neutral' };
                }
                if (bmi < 18.5) {
                    return { category: 'Maigreur', text: 'Augmenter l√©g√®rement vos apports prot√©iques et la r√©cup√©ration vous aidera √† stabiliser votre √©nergie.', tone: 'alert' };
                }
                if (bmi < 25) {
                    return { category: 'Zone optimale', text: 'Continuez √† consolider vos habitudes : maintien musculaire + sommeil profond.', tone: 'success' };
                }
                if (bmi < 30) {
                    return { category: 'Surpoids mod√©r√©', text: 'Un recalibrage nutritionnel et un stress r√©duit peuvent faire baisser votre IMC rapidement.', tone: 'attention' };
                }
                return { category: 'Ob√©sit√©', text: 'Priorit√© : mouvement progressif + nutrition anti-inflammatoire + gestion du stress.', tone: 'critical' };
            }

            function scoreFromBmi(bmi) {
                if (!bmi) return 60;
                if (bmi < 18.5) return 55;
                if (bmi < 25) return 95;
                if (bmi < 27) return 75;
                if (bmi < 30) return 60;
                return 35;
            }

            function validateLead(lead) {
                const errors = [];
                if (!lead.firstname || lead.firstname.length < 2) {
                    errors.push('Pr√©nom requis');
                }
                if (!lead.email || !/^\S+@\S+\.\S+$/.test(lead.email)) {
                    errors.push('Email valide requis');
                }
                if (!lead.birthdate) {
                    errors.push('Date de naissance requise');
                }
                if (!lead.consent) {
                    errors.push('Consentement obligatoire');
                }
                return errors;
            }

            function buildPayload() {
                const timestamp = new Date().toISOString();
                const sessionId = getSessionId();
                state.sessionId = sessionId;

                let ageExact = null;
                const birthdate = state.lead?.birthdate;
                if (birthdate) {
                    const birthDate = new Date(birthdate);
                    const today = new Date();
                    ageExact = today.getFullYear() - birthDate.getFullYear() - ((today.getMonth() < birthDate.getMonth() || (today.getMonth() === birthDate.getMonth() && today.getDate() < birthDate.getDate())) ? 1 : 0);
                }

                const { score: scoreGlobal, factors: scoreByFactor } = calculateScore(state.answers);
                state.scoreByFactor = scoreByFactor;

                const completionStart = window.quizStartTime || state.startedAt || Date.now();
                const completionTime = Math.max(0, Date.now() - completionStart);

                const payload = {
                    sessionId,
                    timestamp,
                    quizId: CONFIG.meta?.quizId || 'vitalite-longevite-v1',
                    quizVersion: CONFIG.meta?.version || '1.0',
                    utm_source: getUrlParam('utm_source') || state.utm?.utm_source || '',
                    utm_medium: getUrlParam('utm_medium') || state.utm?.utm_medium || '',
                    utm_campaign: getUrlParam('utm_campaign') || state.utm?.utm_campaign || '',
                    device: /mobile/i.test(navigator.userAgent) ? 'mobile' : 'desktop',
                    lang: CONFIG.meta?.language || 'fr',

                    firstname: state.lead?.firstname || '',
                    email: state.lead?.email || '',
                    phone: state.lead?.phone || '',
                    dateOfBirth: birthdate || '',
                    ageExact,

                    answers: state.answers || {},
                    height: state.metrics?.height ?? null,
                    weight: state.metrics?.weight ?? null,
                    bmi: state.metrics?.bmi ?? null,

                    scoreGlobal,
                    profile: getProfileFromScore(scoreGlobal),
                    scoreByFactor,
                    recommendations: generateRecommendations(scoreByFactor),

                    completionTime,
                    completionPercent: 100,
                    abandonedAtStep: null,

                    consentGiven: !!state.lead?.consent,
                    consentTimestamp: state.lead?.consent ? timestamp : null
                };

                console.log('Final payload for Google Sheets:', payload);
                return payload;
            }

            async function onClickFormSubmit(event) {
                event.preventDefault();
                if (state.isSubmitting) {
                    return;
                }

                const status = document.getElementById('lead-status');
                if (status) {
                    status.textContent = '';
                    status.style.color = 'var(--text-muted)';
                }

                const firstname = document.getElementById('lead-firstname')?.value?.trim() || '';
                const lastname = document.getElementById('lead-lastname')?.value?.trim() || '';
                const email = document.getElementById('lead-email')?.value?.trim() || '';
                const phone = document.getElementById('lead-phone')?.value?.trim() || '';
                const birthdate = document.getElementById('lead-birthdate')?.value || '';
                const language = document.getElementById('lead-language')?.value || CONFIG.meta.language;
                const consent = document.getElementById('lead-consent')?.checked || false;

                const leadData = { firstname, lastname, email, phone, birthdate, language, consent };
                const errors = validateLead(leadData);
                if (errors.length) {
                    if (status) {
                        status.textContent = errors.join(' ¬∑ ');
                        status.style.color = '#E94B3C';
                    }
                    return;
                }

                state.isSubmitting = true;
                if (status) {
                    status.textContent = 'Analyse des donn√©es en cours‚Ä¶';
                    status.style.color = 'var(--text-muted)';
                }

                state.lead = leadData;
                markStepCompleted('lead');
                recomputeScores();
                persistState();

                trackEvent('lead_submit', {
                    email,
                    phone,
                    completionTimeMs: state.startedAt ? Date.now() - state.startedAt : null
                });

                try {
                    const payload = buildPayload();
                    await submitToGoogleSheets(payload);
                    clearPersistedState();
                    populateResultsScreen();
                    trackEvent('result_view', {
                        finalScore: state.finalScore,
                        profile: state.profile?.name,
                        completionTimeMs: state.startedAt ? Date.now() - state.startedAt : null
                    });
                    goToScreenById('results');
                } catch (error) {
                    console.error('Submit error:', error);
                    if (status) {
                        status.textContent = 'Erreur de connexion. Merci de r√©essayer.';
                        status.style.color = '#E94B3C';
                    }
                    alert('Erreur connexion. R√©essayer?');
                } finally {
                    state.isSubmitting = false;
                }
            }

            async function submitToGoogleSheets(payload) {
                const APPS_SCRIPT_URL = CONFIG.endpoints?.googleScriptUrl || 'https://script.google.com/macros/s/AKfycbwjyAjH9Nl6y2IeRWHi5Qrr6ftqVilH4T9RMPAdNXM_XYVuaN0WFzrPPYwVL8oOZR0W/exec';
                const maxRetries = 3;
                let lastError;

                for (let attempt = 1; attempt <= maxRetries; attempt += 1) {
                    try {
                        console.log(`[Attempt ${attempt}/${maxRetries}] Submitting payload to Google Sheets...`);
                        console.log('Payload:', JSON.stringify(payload, null, 2));

                        const response = await fetch(APPS_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        await new Promise(resolve => setTimeout(resolve, 500));

                        console.log(`[Success on attempt ${attempt}] Response status:`, response.status);
                        trackEvent('lead_submit_success', { attempt, score: payload.scoreGlobal });
                        return { success: true, attempt };
                    } catch (error) {
                        lastError = error;
                        console.error(`[Attempt ${attempt} failed]:`, error.message);

                        if (attempt < maxRetries) {
                            const backoff = Math.pow(2, attempt - 1) * 1000;
                            console.log(`Retrying in ${backoff}ms...`);
                            await new Promise(resolve => setTimeout(resolve, backoff));
                        }
                    }
                }

                console.error('All retries exhausted. Last error:', lastError);
                trackEvent('lead_submit_failed', { retries: maxRetries, error: lastError?.message });
                throw lastError;
            }

            function trackEvent(eventName, params = {}) {
                const eventData = Object.assign({
                    event: eventName,
                    timestamp: new Date().toISOString(),
                    quiz_id: CONFIG.meta?.quizId,
                    version: CONFIG.meta?.version,
                    session_id: state?.sessionId,
                    device: state?.device,
                    lang: CONFIG.meta?.language,
                    screen_id: state?.currentScreenId
                }, state?.utm || {}, params);

                console.log('[Track]', eventName, eventData);

                if (typeof gtag === 'function') {
                    gtag('event', eventName, params);
                }

                if (typeof window.fbq === 'function') {
                    window.fbq('trackCustom', eventName, params);
                }

                if (Array.isArray(window.dataLayer)) {
                    window.dataLayer.push(eventData);
                }

                try {
                    const events = JSON.parse(localStorage.getItem('quiz_events') || '[]');
                    events.push(eventData);
                    localStorage.setItem('quiz_events', JSON.stringify(events.slice(-20)));
                } catch (error) {
                    console.warn('trackEvent storage fallback error', error);
                }
            }

            function showToast(message, tone = 'neutral') {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.dataset.tone = tone;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                requestAnimationFrame(() => {
                    toast.classList.add('visible');
                });
                setTimeout(() => {
                    toast.classList.remove('visible');
                    setTimeout(() => toast.remove(), 320);
                }, 2600);
            }

            function getSessionId() {
                try {
                    let sessionId = sessionStorage.getItem('quiz_session_id');
                    if (!sessionId) {
                        sessionId = `session_${Date.now()}_${Math.random().toString(36).slice(2, 11)}`;
                        sessionStorage.setItem('quiz_session_id', sessionId);
                    }
                    return sessionId;
                } catch (error) {
                    console.warn('Session storage unavailable, generating fallback id', error);
                    return state?.sessionId || generateUUID();
                }
            }

            function getUrlParam(name) {
                try {
                    const params = new URLSearchParams(window.location.search);
                    return params.get(name) || '';
                } catch (error) {
                    console.warn('Unable to read URL parameter', name, error);
                    return '';
                }
            }

            function parseUTMParams() {
                const params = new URLSearchParams(window.location.search);
                return {
                    utm_source: params.get('utm_source') || 'direct',
                    utm_medium: params.get('utm_medium') || 'none',
                    utm_campaign: params.get('utm_campaign') || 'quiz_vitalite',
                    utm_term: params.get('utm_term') || null,
                    utm_content: params.get('utm_content') || null,
                    referrer: document.referrer || null
                };
            }

            function detectDeviceType() {
                const width = window.innerWidth;
                if (width < 640) return 'mobile';
                if (width < 1024) return 'tablet';
                return 'desktop';
            }

            function generateUUID() {
                if (crypto && crypto.randomUUID) {
                    return crypto.randomUUID();
                }
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            function clamp(value, min, max) {
                if (Number.isNaN(value)) return min;
                return Math.min(Math.max(value, min), max);
            }
        })();
    </script>
</body>
</html>
